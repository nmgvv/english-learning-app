{% extends "base.html" %}

{% block title %}ÈòÖËØªÁêÜËß£ - Ëã±ËØ≠Â≠¶‰π†{% endblock %}

{% block body %}
<div class="min-h-screen bg-slate-900 flex flex-col" x-data="readingCompPage()">
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <header class="bg-slate-800/80 backdrop-blur-sm shadow-lg border-b border-slate-700/50">
        <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
            <button @click="goBack" class="text-slate-400 hover:text-slate-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="text-center">
                <span class="font-medium text-slate-100">ÈòÖËØªÁêÜËß£</span>
                <div class="text-xs text-slate-400" x-text="difficultyLabel"></div>
            </div>
            <div class="w-6"></div>
        </div>
    </header>

    <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
    <div x-show="phase === 'loading'" class="flex-1 flex items-center justify-center p-4">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
            <p class="text-slate-400 mb-2">Ê≠£Âú®ÁîüÊàêÈòÖËØªÁêÜËß£È¢òÁõÆ...</p>
            <p class="text-slate-500 text-sm">È¢ÑËÆ°ÈúÄË¶Å 20-40 Áßí</p>
        </div>
    </div>

    <!-- ÈîôËØØÁä∂ÊÄÅ -->
    <div x-show="phase === 'error'" class="flex-1 flex items-center justify-center p-4">
        <div class="text-center max-w-sm">
            <div class="text-4xl mb-4">üòî</div>
            <p class="text-slate-300 mb-4" x-text="error"></p>
            <div class="flex gap-3 justify-center">
                <button @click="goBack" class="px-6 py-2 bg-slate-700 text-slate-200 rounded-lg">
                    ËøîÂõû
                </button>
                <button @click="generateQuestions" class="px-6 py-2 bg-indigo-500 text-white rounded-lg">
                    ÈáçËØï
                </button>
            </div>
        </div>
    </div>

    <!-- ÁªÉ‰π†Èò∂ÊÆµ -->
    <main x-show="phase === 'practice'" x-cloak class="flex-1 flex flex-col max-w-2xl mx-auto w-full p-4 overflow-y-auto">
        <!-- ÊñáÁ´†Âå∫Âüü -->
        <div class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4">
            <div class="flex items-center justify-between mb-3">
                <span class="text-indigo-400 text-sm font-medium" x-text="'‰∏ªÈ¢ò: ' + topic"></span>
                <div class="flex items-center gap-2">
                    <!-- ‰∏≠Ëã±ÂØπÁÖßÊåâÈíÆÔºàÊèê‰∫§ÂêéÊòæÁ§∫Ôºâ -->
                    <button
                        x-show="submitted && passageTranslation.length > 0"
                        @click="showBilingual = !showBilingual"
                        class="px-3 py-1 bg-slate-700 text-slate-200 rounded-lg hover:bg-slate-600 transition flex items-center gap-1 text-sm"
                        :class="showBilingual ? 'bg-indigo-600 hover:bg-indigo-500' : ''"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                        </svg>
                        <span x-text="showBilingual ? 'ÈöêËóèÁøªËØë' : '‰∏≠Ëã±ÂØπÁÖß'"></span>
                    </button>
                    <!-- ÊúóËØªÊåâÈíÆ -->
                    <button
                        @click="playPassage"
                        :disabled="isPlaying"
                        class="px-3 py-1 bg-slate-700 text-slate-200 rounded-lg hover:bg-slate-600 transition flex items-center gap-1 text-sm disabled:opacity-50"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                        </svg>
                        <span x-text="isPlaying ? 'Êí≠Êîæ‰∏≠' : 'ÊúóËØª'"></span>
                    </button>
                </div>
            </div>
            <!-- ÊôÆÈÄöÊòæÁ§∫ÔºàÊú™ÂºÄÂêØÂØπÁÖßÔºâ -->
            <div x-show="!showBilingual" class="text-slate-100 text-base leading-relaxed whitespace-pre-wrap" x-text="passage"></div>
            <!-- ‰∏≠Ëã±ÂØπÁÖßÊòæÁ§∫ -->
            <div x-show="showBilingual" class="space-y-4">
                <template x-for="(para, idx) in paragraphs" :key="idx">
                    <div class="border-l-2 border-indigo-500/50 pl-3">
                        <div class="text-slate-100 text-base leading-relaxed mb-2" x-text="para"></div>
                        <div class="text-slate-400 text-sm leading-relaxed" x-text="passageTranslation[idx] || ''"></div>
                    </div>
                </template>
            </div>
            <div class="mt-3 text-slate-500 text-xs" x-text="'ËØçÊï∞: ' + wordCount"></div>
        </div>

        <!-- È¢òÁõÆÂå∫Âüü -->
        <div class="space-y-4 mb-4">
            <template x-for="(q, idx) in questions" :key="q.number">
                <div class="bg-slate-800/30 rounded-xl p-4 border border-slate-700/30">
                    <!-- È¢òÁõÆ -->
                    <div class="flex items-start gap-2 mb-3">
                        <span class="bg-indigo-500 text-white text-xs px-2 py-1 rounded" x-text="q.number"></span>
                        <span class="text-slate-300" x-text="q.question"></span>
                    </div>
                    <!-- È¢òÂûãÊ†áÁ≠æ -->
                    <div class="text-xs text-slate-500 mb-3" x-text="q.type"></div>
                    <!-- ÈÄâÈ°π -->
                    <div class="space-y-2">
                        <template x-for="(opt, key) in q.options" :key="key">
                            <button
                                @click="selectAnswer(q.number, key)"
                                :disabled="submitted"
                                :class="{
                                    'bg-indigo-600 text-white border-indigo-500': userAnswers[q.number] === key && !submitted,
                                    'bg-emerald-600 text-white border-emerald-500': submitted && key === q.answer,
                                    'bg-rose-600/50 text-white border-rose-500': submitted && userAnswers[q.number] === key && key !== q.answer,
                                    'bg-slate-700/50 text-slate-300 border-slate-600 hover:bg-slate-700': !submitted && userAnswers[q.number] !== key
                                }"
                                class="w-full text-left px-4 py-2 rounded-lg border transition flex items-start gap-2 disabled:cursor-default"
                            >
                                <span class="font-medium" x-text="key + '.'"></span>
                                <span x-text="opt"></span>
                            </button>
                        </template>
                    </div>
                    <!-- Ëß£ÊûêÔºàÊèê‰∫§ÂêéÊòæÁ§∫Ôºâ- ËÄÅÂ∏àËÆ≤Ëß£È£éÊ†º -->
                    <div x-show="submitted && showExplanation[q.number]" class="mt-4 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
                        <div class="flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            <span class="text-indigo-400 font-medium">ËÄÅÂ∏àËÆ≤Ëß£</span>
                        </div>
                        <div class="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap" x-text="q.teaching_explanation || q.explanation || 'ÊöÇÊó†Ëß£Êûê'"></div>
                    </div>
                    <!-- Êü•ÁúãËß£ÊûêÊåâÈíÆ -->
                    <button
                        x-show="submitted && !showExplanation[q.number]"
                        @click="showExplanation[q.number] = true"
                        class="mt-3 text-indigo-400 text-sm hover:text-indigo-300"
                    >
                        Êü•ÁúãËÄÅÂ∏àËÆ≤Ëß£ ‚Üí
                    </button>
                </div>
            </template>
        </div>

        <!-- Êèê‰∫§ÊåâÈíÆ -->
        <div class="mt-auto">
            <button
                x-show="!submitted"
                @click="submitAnswers"
                :disabled="!canSubmit"
                class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-medium hover:from-indigo-600 hover:to-purple-600 transition disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Êèê‰∫§Á≠îÊ°à
            </button>
        </div>
    </main>

    <!-- ÁªìÊûúÈò∂ÊÆµ -->
    <main x-show="phase === 'results'" x-cloak class="flex-1 flex flex-col max-w-2xl mx-auto w-full p-4">
        <!-- ÂæóÂàÜÂ±ïÁ§∫ -->
        <div class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-6 mb-4 text-center">
            <div class="text-slate-400 text-sm mb-2">Êú¨Ê¨°ÂæóÂàÜ</div>
            <div
                :class="{
                    'text-emerald-400': score >= 75,
                    'text-amber-400': score >= 50 && score < 75,
                    'text-rose-400': score < 50
                }"
                class="text-5xl font-bold mb-2"
                x-text="score"
            ></div>
            <div class="text-slate-400 text-sm">
                Á≠îÂØπ <span class="text-emerald-400" x-text="correctCount"></span> / <span x-text="questions.length"></span> È¢ò
            </div>
        </div>

        <!-- Á≠îÈ¢òËØ¶ÊÉÖ -->
        <div class="bg-slate-800/30 rounded-xl p-4 mb-4">
            <div class="text-slate-400 text-sm mb-3">Á≠îÈ¢òËØ¶ÊÉÖ</div>
            <template x-for="r in results" :key="r.number">
                <div class="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-b-0">
                    <div class="flex items-center gap-2">
                        <span class="text-slate-400 text-sm" x-text="'Á¨¨' + r.number + 'È¢ò'"></span>
                        <span
                            :class="r.is_correct ? 'text-emerald-400' : 'text-rose-400'"
                            class="text-sm"
                            x-text="r.is_correct ? '‚úì Ê≠£Á°Æ' : '‚úó ÈîôËØØ'"
                        ></span>
                    </div>
                    <div class="text-slate-500 text-sm">
                        <span x-show="!r.is_correct">
                            ‰Ω†ÁöÑÁ≠îÊ°à: <span class="text-rose-400" x-text="r.user_answer || 'Êú™‰ΩúÁ≠î'"></span>
                            Ê≠£Á°ÆÁ≠îÊ°à: <span class="text-emerald-400" x-text="r.correct_answer"></span>
                        </span>
                    </div>
                </div>
            </template>
        </div>

        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <div class="mt-auto flex gap-3">
            <button
                @click="reviewQuestions"
                class="flex-1 py-3 bg-slate-700 text-slate-200 rounded-xl hover:bg-slate-600 transition"
            >
                Êü•ÁúãËß£Êûê
            </button>
            <button
                @click="generateQuestions"
                class="flex-1 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-medium hover:from-indigo-600 hover:to-purple-600 transition"
            >
                ÂÜçÊù•‰∏ÄÁØá
            </button>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
function readingCompPage() {
    return {
        // ÈÖçÁΩÆ
        difficulty: '{{ difficulty }}',

        // Êï∞ÊçÆ
        passage: '',
        passageTranslation: [],
        wordCount: 0,
        topic: '',
        vocabulary: [],
        questions: [],

        // Áä∂ÊÄÅ
        phase: 'loading',  // loading, practice, results, error
        error: null,
        isPlaying: false,
        submitted: false,
        showBilingual: false,

        // ËÆ°ÁÆóÂ±ûÊÄßÔºöÊÆµËêΩÊï∞ÁªÑ
        get paragraphs() {
            return this.passage.split('\n\n').filter(p => p.trim());
        },

        // Á≠îÈ¢òÊï∞ÊçÆ
        userAnswers: {},
        showExplanation: {},

        // ÁªìÊûúÊï∞ÊçÆ
        results: [],
        score: 0,
        correctCount: 0,

        get difficultyLabel() {
            return this.difficulty === 'hard' ? 'ËæÉÈ´òÈöæÂ∫¶' : '‰∏≠Á≠âÈöæÂ∫¶';
        },

        get canSubmit() {
            return Object.keys(this.userAnswers).length === this.questions.length;
        },

        async init() {
            await this.generateQuestions();
        },

        async generateQuestions() {
            this.phase = 'loading';
            this.error = null;
            this.submitted = false;
            this.userAnswers = {};
            this.showExplanation = {};
            this.results = [];

            try {
                const response = await fetch('/api/reading-comprehension/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ difficulty: this.difficulty })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'ÁîüÊàêÂ§±Ë¥•');
                }

                const data = await response.json();

                this.passage = data.passage;
                this.passageTranslation = data.passage_translation || [];
                this.wordCount = data.word_count || 0;
                this.topic = data.topic || '';
                this.vocabulary = data.vocabulary || [];
                this.questions = data.questions || [];
                this.showBilingual = false;

                this.phase = 'practice';

            } catch (e) {
                console.error('ÁîüÊàêÈ¢òÁõÆÂ§±Ë¥•:', e);
                this.error = e.message || 'ÁîüÊàêÈ¢òÁõÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï';
                this.phase = 'error';
            }
        },

        async playPassage() {
            if (!this.passage || this.isPlaying) return;

            this.isPlaying = true;
            try {
                await TTS.playSentence(this.passage);
            } catch (e) {
                console.error('Êí≠ÊîæÂ§±Ë¥•:', e);
            } finally {
                this.isPlaying = false;
            }
        },

        selectAnswer(questionNumber, answer) {
            if (this.submitted) return;
            this.userAnswers[questionNumber] = answer;
        },

        async submitAnswers() {
            if (!this.canSubmit) return;

            try {
                const response = await fetch('/api/reading-comprehension/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questions: this.questions,
                        answers: this.userAnswers
                    })
                });

                if (!response.ok) {
                    throw new Error('Êèê‰∫§Â§±Ë¥•');
                }

                const data = await response.json();

                this.results = data.results;
                this.score = data.score;
                this.correctCount = data.correct_count;
                this.submitted = true;
                this.phase = 'results';

            } catch (e) {
                console.error('Êèê‰∫§Â§±Ë¥•:', e);
                alert('Êèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        },

        reviewQuestions() {
            // ËøîÂõûÁªÉ‰π†È°µÈù¢Êü•ÁúãËß£Êûê
            this.phase = 'practice';
            // Â±ïÂºÄÊâÄÊúâËß£Êûê
            this.questions.forEach(q => {
                this.showExplanation[q.number] = true;
            });
        },

        goBack() {
            TTS.stop();
            window.location.href = '/';
        }
    }
}
</script>
{% endblock %}
