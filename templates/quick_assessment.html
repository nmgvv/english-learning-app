{% extends "base.html" %}

{% block title %}å¿«é€Ÿæ‘¸åº• - è‹±è¯­å­¦ä¹ {% endblock %}

{% block body %}
<div class="min-h-screen bg-slate-900" x-data="assessmentPage()">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-slate-800/80 backdrop-blur-sm shadow-lg sticky top-0 z-10 border-b border-slate-700/50">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <a href="/" class="text-slate-400 hover:text-slate-200 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-lg font-bold text-slate-100">å¿«é€Ÿæ‘¸åº•</h1>
            </div>
            <div class="text-sm text-slate-400">
                <span x-text="masteredCount + notMasteredCount"></span> / <span x-text="totalCount"></span>
            </div>
        </div>
    </header>

    <!-- é¡¶éƒ¨è¿›åº¦æ¡ -->
    <div class="bg-slate-800 px-4 py-3" x-show="!finished && !batchComplete">
        <div class="text-sm text-slate-400 mb-1">
            æœ¬æ‰¹è¿›åº¦: <span x-text="masteredCount + notMasteredCount"></span> / <span x-text="totalCount"></span>
        </div>
        <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
            <div class="h-full bg-gradient-to-r from-emerald-500 to-sky-500 transition-all"
                 :style="`width: ${totalCount > 0 ? (masteredCount + notMasteredCount) / totalCount * 100 : 0}%`"></div>
        </div>
    </div>

    <!-- åŠ è½½ä¸­ -->
    <div x-show="loading" class="flex items-center justify-center py-20">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-sky-500 mx-auto mb-4"></div>
            <p class="text-slate-400">åŠ è½½ä¸­...</p>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº - ç­”é¢˜ç•Œé¢ -->
    <div class="p-4 max-w-lg mx-auto" x-show="!finished && !batchComplete && !loading">
        <!-- ä¸­æ–‡é‡Šä¹‰ï¼ˆå¤§å·æ˜¾ç¤ºï¼‰ -->
        <div class="bg-slate-800 rounded-xl p-6 mb-6 text-center border border-slate-700/50">
            <div class="text-2xl font-bold text-slate-100 leading-relaxed" x-text="currentWord?.translation"></div>
        </div>

        <!-- å››ä¸ªè‹±æ–‡é€‰é¡¹ -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <template x-for="(opt, idx) in options" :key="idx">
                <button
                    @click="selectOption(opt)"
                    :disabled="answered"
                    :class="getOptionClass(opt)"
                    class="border-2 rounded-xl p-4 text-lg font-medium transition"
                    x-text="opt"
                ></button>
            </template>
        </div>
    </div>

    <!-- æ‰¹æ¬¡å®Œæˆé¡µ -->
    <div x-show="batchComplete && !finished" class="p-4 max-w-lg mx-auto text-center">
        <div class="bg-slate-800 rounded-xl p-6 mb-6 border border-slate-700/50">
            <h2 class="text-xl font-bold text-slate-100 mb-4">æœ¬æ‰¹æ‘¸åº•å®Œæˆ!</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-4">
                    <div class="text-3xl font-bold text-emerald-400" x-text="masteredCount"></div>
                    <div class="text-sm text-slate-400">å·²æŒæ¡</div>
                </div>
                <div class="bg-amber-500/10 border border-amber-500/20 rounded-lg p-4">
                    <div class="text-3xl font-bold text-amber-400" x-text="notMasteredCount"></div>
                    <div class="text-sm text-slate-400">éœ€å­¦ä¹ </div>
                </div>
            </div>
            <div class="text-sm text-slate-400">
                æ­£ç¡®ç‡: <span class="text-sky-400" x-text="`${Math.round(masteredCount / (masteredCount + notMasteredCount) * 100)}%`"></span>
            </div>
        </div>
        <div class="space-y-3">
            <button x-show="hasMore" @click="continueTesting"
                class="w-full py-3 rounded-xl bg-sky-600 text-white font-medium hover:bg-sky-500 transition">
                ç»§ç»­ä¸‹ä¸€æ‰¹
            </button>
            <button @click="goToLearn"
                class="w-full py-3 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-500 transition">
                å¼€å§‹å­¦ä¹ ï¼ˆæœªæŒæ¡è¯æ±‡ï¼‰
            </button>
            <button @click="goHome"
                class="w-full py-3 rounded-xl bg-slate-700 text-slate-200 font-medium hover:bg-slate-600 transition">
                è¿”å›é¦–é¡µ
            </button>
        </div>
    </div>

    <!-- å…¨éƒ¨å®Œæˆé¡µ -->
    <div x-show="finished" class="p-4 max-w-lg mx-auto text-center">
        <div class="bg-slate-800 rounded-xl p-6 mb-6 border border-slate-700/50">
            <div class="text-5xl mb-4">ğŸ‰</div>
            <h2 class="text-xl font-bold text-slate-100 mb-2">å…¨éƒ¨æ‘¸åº•å®Œæˆ!</h2>
            <p class="text-slate-400">é«˜è€ƒè¯æ±‡æ‘¸åº•æµ‹è¯•å·²å®Œæˆ</p>
        </div>
        <div class="space-y-3">
            <button @click="goToLearn"
                class="w-full py-3 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-500 transition">
                å¼€å§‹å­¦ä¹ æœªæŒæ¡è¯æ±‡
            </button>
            <button @click="goToReview"
                class="w-full py-3 rounded-xl bg-amber-600 text-white font-medium hover:bg-amber-500 transition">
                å¤ä¹ å·²æŒæ¡è¯æ±‡
            </button>
            <button @click="goHome"
                class="w-full py-3 rounded-xl bg-slate-700 text-slate-200 font-medium hover:bg-slate-600 transition">
                è¿”å›é¦–é¡µ
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function assessmentPage() {
    return {
        currentWord: null,
        options: [],
        selectedOption: null,
        answered: false,
        finished: false,
        masteredCount: 0,
        notMasteredCount: 0,
        totalCount: 0,
        batchSize: {{ batch_size }},
        batchComplete: false,
        hasMore: false,
        loading: true,
        submitting: false,
        nextWordData: null,
        prefetchPromise: null,

        async init() {
            await this.startBatch();
        },

        async startBatch() {
            this.loading = true;
            try {
                const res = await fetch(`/api/assessment/batch?batch_size=${this.batchSize}`);
                const data = await res.json();

                if (data.words.length === 0) {
                    this.finished = true;
                    this.loading = false;
                    return;
                }

                this.currentWord = data.words[0];
                this.options = this.currentWord.options;
                this.selectedOption = null;
                this.answered = false;
                this.hasMore = data.remaining > 0;
                this.totalCount = data.total_batch;
                this.masteredCount = 0;
                this.notMasteredCount = 0;
                this.batchComplete = false;

                // ç«‹å³é¢„åŠ è½½ä¸‹ä¸€é¢˜
                this.prefetchNext();
            } catch (e) {
                console.error('åŠ è½½å¤±è´¥:', e);
            }
            this.loading = false;
        },

        prefetchNext() {
            // åœ¨åå°é¢„åŠ è½½ä¸‹ä¸€ä¸ªè¯æ±‡ï¼ˆå«å¤§æ¨¡å‹ç”Ÿæˆå¹²æ‰°è¯ï¼‰
            this.nextWordData = null;
            this.prefetchPromise = fetch(`/api/assessment/next?exclude=${this.currentWord.word}`)
                .then(res => res.json())
                .then(data => {
                    this.nextWordData = data;
                    return data;
                })
                .catch(e => {
                    console.error('é¢„åŠ è½½å¤±è´¥:', e);
                    return null;
                });
        },

        getOptionClass(opt) {
            if (!this.answered) {
                return this.selectedOption === opt
                    ? 'bg-sky-600 border-sky-500 text-white'
                    : 'bg-slate-800 border-slate-700 text-slate-200 hover:border-slate-600';
            }
            if (opt === this.currentWord.word) {
                return 'bg-emerald-600 border-emerald-500 text-white';
            }
            if (opt === this.selectedOption && opt !== this.currentWord.word) {
                return 'bg-red-600 border-red-500 text-white';
            }
            return 'bg-slate-800 border-slate-700 text-slate-500 opacity-50';
        },

        async selectOption(opt) {
            if (this.answered || this.submitting) return;

            this.selectedOption = opt;
            this.answered = true;
            this.submitting = true;

            const correct = opt === this.currentWord.word;

            // æäº¤ç­”æ¡ˆï¼ˆä¸é˜»å¡ UIï¼‰
            fetch('/api/assessment/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    word: this.currentWord.word,
                    correct: correct,
                    selected: opt
                })
            }).catch(e => console.error('æäº¤å¤±è´¥:', e));

            if (correct) {
                this.masteredCount++;
            } else {
                this.notMasteredCount++;
            }

            // çŸ­æš‚æ˜¾ç¤ºå¯¹é”™åé¦ˆåè‡ªåŠ¨è·³è½¬
            setTimeout(async () => {
                // æ£€æŸ¥æœ¬æ‰¹æ˜¯å¦å®Œæˆ
                if (this.masteredCount + this.notMasteredCount >= this.totalCount) {
                    this.batchComplete = true;
                    this.submitting = false;
                    return;
                }

                await this.showNext();
                this.submitting = false;
            }, correct ? 500 : 1000);
        },

        async showNext() {
            // ç­‰å¾…é¢„åŠ è½½å®Œæˆï¼ˆé€šå¸¸å·²å®Œæˆï¼‰
            if (this.prefetchPromise) {
                await this.prefetchPromise;
            }

            const data = this.nextWordData;

            if (!data || data.done) {
                this.finished = true;
                return;
            }

            this.currentWord = data;
            this.options = data.options;
            this.selectedOption = null;
            this.answered = false;

            // ç«‹å³é¢„åŠ è½½ä¸‹ä¸‹ä¸€é¢˜
            this.prefetchNext();
        },

        async continueTesting() {
            this.batchComplete = false;
            await this.startBatch();
        },

        goToReview() {
            window.location.href = '/dictation?mode=review';
        },

        goToLearn() {
            window.location.href = '/dictation/gaokao_3500?mode=new';
        },

        goHome() {
            window.location.href = '/';
        }
    }
}
</script>
{% endblock %}
