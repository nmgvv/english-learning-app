{% extends "base.html" %}

{% block title %}å¬å†™ç»ƒä¹  - è‹±è¯­å­¦ä¹ {% endblock %}

{% block body %}
<div class="min-h-screen bg-slate-900 flex flex-col" x-data="dictationPage()">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-slate-800/80 backdrop-blur-sm shadow-lg border-b border-slate-700/50">
        <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
            <button @click="goBack" class="text-slate-400 hover:text-slate-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="text-center">
                <span class="font-medium text-slate-100">å¬å†™ç»ƒä¹ </span>
                <div class="text-xs text-slate-400">
                    <span x-text="currentIndex + 1"></span> / <span x-text="cards.length"></span>
                </div>
            </div>
            <div class="w-6"></div>
        </div>
        <!-- è¿›åº¦æ¡ -->
        <div class="h-1 bg-slate-700/50">
            <div
                class="h-full bg-gradient-to-r from-sky-500 to-blue-500 transition-all duration-300"
                :style="`width: ${cards.length > 0 ? ((currentIndex) / cards.length * 100) : 0}%`"
            ></div>
        </div>
    </header>

    <!-- åŠ è½½ä¸­ -->
    <div x-show="loading" class="flex-1 flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-sky-500 border-t-transparent mx-auto"></div>
            <p class="text-slate-400 mt-4">åŠ è½½ä¸­...</p>
        </div>
    </div>

    <!-- æ— å•è¯ -->
    <div x-show="!loading && cards.length === 0" x-cloak class="flex-1 flex items-center justify-center p-4">
        <div class="text-center">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 class="text-xl font-medium text-slate-200 mb-2">æš‚æ— å•è¯</h2>
            <p class="text-slate-400 mb-6">å½“å‰æ²¡æœ‰éœ€è¦å­¦ä¹ çš„å•è¯</p>
            <button @click="goBack" class="bg-gradient-to-r from-sky-500 to-blue-500 text-white px-6 py-2 rounded-lg shadow-lg shadow-blue-500/20">è¿”å›</button>
        </div>
    </div>

    <!-- å­¦ä¹ å®Œæˆ -->
    <div x-show="!loading && finished" x-cloak class="flex-1 flex items-center justify-center p-4">
        <div class="text-center bg-slate-800/50 backdrop-blur rounded-2xl shadow-xl border border-slate-700/50 p-8 max-w-sm w-full">
            <div class="text-6xl mb-4">ğŸŠ</div>
            <h2 class="text-2xl font-bold text-slate-100 mb-2">å­¦ä¹ å®Œæˆ!</h2>
            <div class="grid grid-cols-2 gap-4 my-6">
                <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3">
                    <div class="text-2xl font-bold text-emerald-400" x-text="correctCount"></div>
                    <div class="text-sm text-slate-400">æ­£ç¡®</div>
                </div>
                <div class="bg-rose-500/10 border border-rose-500/20 rounded-lg p-3">
                    <div class="text-2xl font-bold text-rose-400" x-text="wrongCount"></div>
                    <div class="text-sm text-slate-400">é”™è¯¯</div>
                </div>
            </div>
            <p class="text-slate-300 mb-6">
                æ­£ç¡®ç‡: <span class="font-bold" x-text="Math.round(correctCount / (correctCount + wrongCount) * 100) || 0"></span>%
            </p>
            <!-- å¯¹è¯ç»ƒä¹ æŒ‰é’®ï¼ˆä»…å­¦æ–°è¯æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
            <button
                x-show="mode === 'new' && cards.length >= 5"
                @click="startConversationPractice"
                class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-3 rounded-lg font-medium mb-3 shadow-lg shadow-orange-500/20 hover:from-amber-600 hover:to-orange-600 transition"
            >
                ğŸ¤ å¼€å§‹å¯¹è¯ç»ƒä¹ 
            </button>
            <button @click="goBack" class="w-full bg-gradient-to-r from-sky-500 to-blue-500 text-white py-3 rounded-lg font-medium shadow-lg shadow-blue-500/20 hover:from-sky-600 hover:to-blue-600 transition">è¿”å›é¦–é¡µ</button>
        </div>
    </div>

    <!-- å­¦ä¹ ç•Œé¢ -->
    <main x-show="!loading && cards.length > 0 && !finished" x-cloak class="flex-1 flex flex-col max-w-2xl mx-auto w-full p-4">
        <!-- å•è¯å¡ç‰‡ -->
        <div class="bg-slate-800/50 backdrop-blur rounded-2xl shadow-xl border border-slate-700/50 flex-1 flex flex-col p-6">
            <!-- ä¸­æ–‡é‡Šä¹‰ -->
            <div class="text-center py-8">
                <div class="text-3xl font-bold text-slate-100" x-text="splitTranslation(currentCard?.translation || '').main"></div>
                <div class="text-sm text-slate-400 mt-2" x-show="splitTranslation(currentCard?.translation || '').extended" x-text="splitTranslation(currentCard?.translation || '').extended"></div>
                <div class="text-slate-500 mt-2" x-show="showPhonetic" x-text="currentCard?.phonetic || ''"></div>
                <!-- å¤ä¹ æ¨¡å¼ä¸‹æ˜¾ç¤ºè¯ä¹¦æ¥æº -->
                <div x-show="mode === 'review' && currentCard?.book_id" class="text-xs text-slate-500 mt-2">
                    æ¥è‡ª: <span x-text="getBookName(currentCard?.book_id)"></span>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="flex-1 flex flex-col justify-center">
                <!-- è¾“å…¥æ¡† -->
                <div class="relative">
                    <input
                        type="text"
                        x-model="userInput"
                        :disabled="inputDisabled"
                        x-ref="inputField"
                        class="w-full text-center text-2xl py-4 bg-slate-700/50 border-2 border-slate-600 text-slate-100 rounded-xl focus:border-sky-500 focus:ring-0 outline-none transition disabled:bg-slate-700/30 disabled:text-slate-500"
                        :class="{
                            'border-emerald-500 bg-emerald-500/10': showResult && isCorrect,
                            'border-rose-500 bg-rose-500/10': showResult && !isCorrect
                        }"
                        placeholder="è¯·è¾“å…¥å•è¯"
                        autocomplete="off"
                        autocapitalize="none"
                        spellcheck="false"
                    >
                    <!-- æ­£ç¡®/é”™è¯¯å›¾æ ‡ -->
                    <div x-show="showResult" class="absolute right-4 top-1/2 -translate-y-1/2">
                        <span x-show="isCorrect" class="text-emerald-400 text-2xl">âœ“</span>
                        <span x-show="!isCorrect" class="text-rose-400 text-2xl">âœ—</span>
                    </div>
                </div>

                <!-- æç¤ºåŒºåŸŸ -->
                <div class="mt-4 min-h-[60px]">
                    <!-- é”™è¯¯æç¤º -->
                    <div x-show="hint" x-cloak class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-center">
                        <span class="text-amber-400" x-text="hint"></span>
                        <span class="text-slate-400 text-sm ml-2" x-show="remainingAttempts > 0">
                            è¿˜æœ‰ <span x-text="remainingAttempts"></span> æ¬¡æœºä¼š
                        </span>
                    </div>

                    <!-- ä¾‹å¥æç¤º -->
                    <div x-show="exampleSentence" x-cloak class="bg-sky-500/10 border border-sky-500/30 rounded-lg p-3">
                        <div class="text-sky-300" x-text="exampleSentence"></div>
                        <div class="text-slate-400 text-sm mt-1" x-text="exampleChinese"></div>
                    </div>

                    <!-- æ­£ç¡®ç­”æ¡ˆ -->
                    <div x-show="showAnswer" x-cloak class="text-center">
                        <div class="text-slate-400 text-sm">æ­£ç¡®ç­”æ¡ˆ</div>
                        <div class="text-2xl font-bold text-slate-100 mt-1" x-text="currentCard?.word || ''"></div>
                        <div class="text-slate-500 text-sm mt-1" x-text="currentCard?.phonetic || ''"></div>
                    </div>
                </div>
            </div>

            <!-- éŸ³è‰² + è¯­é€Ÿé€‰æ‹© -->
            <div x-show="!showPronunciationUI" class="py-4">
                <!-- å››ä¸ªéŸ³è‰²æŒ‰é’® -->
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <template x-for="v in TTS.voices" :key="v.id">
                        <button
                            @click="playVoice(v.id)"
                            :disabled="attempt === 0 && !showResult"
                            :class="currentVoice === v.id
                                ? 'bg-sky-500/30 border-sky-500/60 text-sky-300'
                                : 'bg-slate-700/50 border-slate-600 text-slate-300 hover:bg-slate-600/50'"
                            class="py-2 px-1 rounded-lg text-xs font-medium border transition disabled:opacity-40 disabled:cursor-not-allowed"
                            x-text="v.label"
                        ></button>
                    </template>
                </div>
                <!-- ä¸‰ä¸ªè¯­é€ŸæŒ‰é’® -->
                <div class="flex justify-center gap-2">
                    <template x-for="s in TTS.speeds" :key="s.id">
                        <button
                            @click="currentSpeed = s.id; TTS.setSpeed(s.id)"
                            :class="currentSpeed === s.id
                                ? 'bg-amber-500/30 border-amber-500/60 text-amber-300'
                                : 'bg-slate-700/50 border-slate-600 text-slate-400 hover:bg-slate-600/50'"
                            class="px-4 py-1.5 rounded-lg text-xs font-medium border transition"
                            x-text="s.label"
                        ></button>
                    </template>
                </div>
            </div>

            <!-- è·Ÿè¯»å‘éŸ³è¯„ä¼°ç•Œé¢ -->
            <div x-show="showPronunciationUI" x-cloak class="mt-4 bg-purple-500/10 border border-purple-500/30 rounded-xl p-4">
                <div class="text-center mb-4">
                    <div class="text-lg font-medium text-purple-300 mb-1">è·Ÿè¯»ç»ƒä¹ </div>
                    <div class="text-2xl font-bold text-slate-100" x-text="currentCard?.word || ''"></div>
                    <div class="text-slate-400 text-sm mt-1" x-text="currentCard?.phonetic || ''"></div>
                </div>

                <!-- è¯„ä¼°ç»“æœ -->
                <div x-show="pronunciationResult?.success" class="mb-4 bg-slate-800/50 rounded-lg p-3">
                    <div class="flex justify-center space-x-6 text-sm">
                        <div class="text-center">
                            <div class="text-slate-400">å‡†ç¡®åº¦</div>
                            <div class="text-xl font-bold"
                                :class="{
                                    'text-emerald-400': pronunciationResult?.accuracy_score >= 75,
                                    'text-amber-400': pronunciationResult?.accuracy_score >= 60 && pronunciationResult?.accuracy_score < 75,
                                    'text-rose-400': pronunciationResult?.accuracy_score < 60
                                }"
                                x-text="Math.round(pronunciationResult?.accuracy_score || 0) + '%'"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-slate-400">æµç•…åº¦</div>
                            <div class="text-xl font-bold"
                                :class="{
                                    'text-emerald-400': pronunciationResult?.fluency_score >= 75,
                                    'text-amber-400': pronunciationResult?.fluency_score >= 60 && pronunciationResult?.fluency_score < 75,
                                    'text-rose-400': pronunciationResult?.fluency_score < 60
                                }"
                                x-text="Math.round(pronunciationResult?.fluency_score || 0) + '%'"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-slate-400">å®Œæ•´åº¦</div>
                            <div class="text-xl font-bold"
                                :class="{
                                    'text-emerald-400': pronunciationResult?.completeness_score >= 75,
                                    'text-amber-400': pronunciationResult?.completeness_score >= 60 && pronunciationResult?.completeness_score < 75,
                                    'text-rose-400': pronunciationResult?.completeness_score < 60
                                }"
                                x-text="Math.round(pronunciationResult?.completeness_score || 0) + '%'"></div>
                        </div>
                    </div>
                    <!-- è¯†åˆ«å‡ºçš„æ–‡æœ¬ -->
                    <div x-show="pronunciationResult?.recognized_text" class="mt-2 text-center text-slate-400 text-sm">
                        è¯†åˆ«: <span class="text-slate-300" x-text="pronunciationResult?.recognized_text"></span>
                    </div>

                    <!-- å­—æ¯-éŸ³ç´ å¯¹ç…§åˆ†æ -->
                    <div x-show="pronunciationResult?.letter_mapping?.length > 0" class="mt-3 pt-3 border-t border-slate-700">
                        <div class="text-xs text-slate-400 mb-2 text-center">å‘éŸ³åˆ†æ</div>
                        <!-- å­—æ¯è¡Œ -->
                        <div class="flex flex-wrap justify-center gap-1 mb-1">
                            <template x-for="(m, i) in pronunciationResult?.letter_mapping || []" :key="'letter-'+i">
                                <span
                                    class="px-2 py-1 rounded text-base font-bold cursor-default"
                                    :class="{
                                        'bg-emerald-500/20 text-emerald-300': m.accuracy >= 80,
                                        'bg-amber-500/20 text-amber-300': m.accuracy >= 60 && m.accuracy < 80,
                                        'bg-rose-500/20 text-rose-300': m.accuracy !== null && m.accuracy < 60,
                                        'bg-slate-700/50 text-slate-400': m.accuracy === null
                                    }"
                                    :title="m.accuracy !== null ? 'å‡†ç¡®åº¦: ' + Math.round(m.accuracy) + '%' : ''"
                                    x-text="m.letter"
                                ></span>
                            </template>
                        </div>
                        <!-- éŸ³ç´ è¡Œ -->
                        <div class="flex flex-wrap justify-center gap-1">
                            <template x-for="(m, i) in pronunciationResult?.letter_mapping || []" :key="'phoneme-'+i">
                                <span
                                    class="px-2 py-0.5 text-xs font-mono text-slate-500"
                                    :style="'min-width: ' + (m.letter.length * 0.6 + 1) + 'rem'"
                                    x-text="m.phoneme || ''"
                                ></span>
                            </template>
                        </div>
                        <!-- é—®é¢˜å­—æ¯æç¤º -->
                        <div x-show="pronunciationResult?.letter_mapping?.filter(m => m.accuracy !== null && m.accuracy < 60).length > 0"
                             class="mt-2 text-center text-xs text-rose-400">
                            <span>éœ€è¦æ³¨æ„: </span>
                            <span x-text="pronunciationResult?.letter_mapping?.filter(m => m.accuracy !== null && m.accuracy < 60).map(m => m.letter + ' /' + m.phoneme + '/').join(', ')"></span>
                        </div>
                    </div>
                    <!-- æ—§ç‰ˆéŸ³ç´ è¯¦æƒ…ï¼ˆä½œä¸ºåå¤‡ï¼‰ -->
                    <div x-show="!pronunciationResult?.letter_mapping?.length && pronunciationResult?.phoneme_details?.length > 0" class="mt-3 pt-3 border-t border-slate-700">
                        <div class="text-xs text-slate-400 mb-2 text-center">éŸ³ç´ åˆ†æ</div>
                        <div class="flex flex-wrap justify-center gap-1">
                            <template x-for="(p, i) in pronunciationResult?.phoneme_details || []" :key="i">
                                <span
                                    class="px-2 py-1 rounded text-sm font-mono cursor-default"
                                    :class="{
                                        'bg-emerald-500/20 text-emerald-300': p.accuracy >= 80,
                                        'bg-amber-500/20 text-amber-300': p.accuracy >= 60 && p.accuracy < 80,
                                        'bg-rose-500/20 text-rose-300': p.accuracy < 60
                                    }"
                                    :title="'å‡†ç¡®åº¦: ' + Math.round(p.accuracy) + '%'"
                                    x-text="p.phoneme"
                                ></span>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- åé¦ˆæ–‡æœ¬ -->
                <div class="text-center text-slate-300 mb-2" x-text="pronunciationFeedback"></div>

                <!-- å‘éŸ³æŠ€å·§æç¤º -->
                <div x-show="pronunciationResult?.tips" class="text-center text-xs text-amber-400/80 mb-2">
                    <span class="inline-flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span x-text="pronunciationResult?.tips"></span>
                    </span>
                </div>

                <!-- æ¨èç»ƒä¹ å•è¯ -->
                <div x-show="pronunciationResult?.practice_words?.length > 0" class="mb-4 p-3 bg-indigo-500/10 border border-indigo-500/30 rounded-lg">
                    <div class="text-xs text-indigo-300 mb-2 text-center">
                        <span x-show="pronunciationResult?.focus_phoneme">
                            ç»ƒä¹  /<span x-text="pronunciationResult?.focus_phoneme"></span>/ éŸ³ï¼š
                        </span>
                        <span x-show="!pronunciationResult?.focus_phoneme">æ¨èç»ƒä¹ ï¼š</span>
                    </div>
                    <div class="flex flex-col gap-2">
                        <template x-for="(pw, i) in pronunciationResult?.practice_words || []" :key="'pw-'+i">
                            <button
                                @click="playPracticeWord(pw.word || pw)"
                                :disabled="audioPlaying"
                                class="px-4 py-2 bg-indigo-500/20 text-indigo-200 rounded-lg hover:bg-indigo-500/30 transition disabled:opacity-50 flex items-center gap-3"
                            >
                                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                                </svg>
                                <span class="font-medium" x-text="pw.word || pw"></span>
                                <span x-show="pw.pos" class="text-xs text-indigo-400" x-text="pw.pos"></span>
                                <span x-show="pw.meaning" class="text-xs text-gray-400" x-text="pw.meaning"></span>
                            </button>
                        </template>
                    </div>
                </div>

                <!-- å½•éŸ³æŒ‰é’® -->
                <div class="flex justify-center mb-4">
                    <button
                        @click="togglePronunciationRecording()"
                        :disabled="pronunciationSubmitting || audioPlaying"
                        class="w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 disabled:opacity-50"
                        :class="{
                            'bg-rose-500 hover:bg-rose-600 animate-pulse': isRecordingPronunciation,
                            'bg-purple-500 hover:bg-purple-600': !isRecordingPronunciation
                        }"
                    >
                        <svg x-show="!isRecordingPronunciation" class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        <svg x-show="isRecordingPronunciation" class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                        </svg>
                    </button>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="flex justify-center space-x-4">
                    <button
                        @click="replayPronunciationDemo()"
                        :disabled="audioPlaying || isRecordingPronunciation"
                        class="px-4 py-2 bg-slate-700/50 text-slate-300 rounded-lg hover:bg-slate-600/50 transition disabled:opacity-50"
                    >
                        å†å¬ä¸€é
                    </button>

                    <!-- å†è¯•ä¸€æ¬¡ï¼ˆæœªè¾¾åˆ°æœ€å¤§æ¬¡æ•°ä¸”æœ‰è¯„ä¼°ç»“æœæ—¶æ˜¾ç¤ºï¼‰ -->
                    <button
                        x-show="pronunciationResult && pronunciationAttempt < maxPronunciationAttempts"
                        @click="retryPronunciation()"
                        :disabled="audioPlaying || isRecordingPronunciation"
                        class="px-4 py-2 bg-amber-500/20 text-amber-300 rounded-lg hover:bg-amber-500/30 transition disabled:opacity-50"
                    >
                        å†è¯•ä¸€æ¬¡
                    </button>

                    <!-- ç»§ç»­ï¼ˆæœ‰è¯„ä¼°ç»“æœæˆ–è¾¾åˆ°æœ€å¤§æ¬¡æ•°æ—¶æ˜¾ç¤ºï¼‰ -->
                    <button
                        x-show="pronunciationResult || pronunciationAttempt >= maxPronunciationAttempts"
                        @click="continuePronunciation()"
                        :disabled="audioPlaying"
                        class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition disabled:opacity-50"
                    >
                        ç»§ç»­
                    </button>

                    <!-- è·³è¿‡ï¼ˆæ²¡æœ‰è¯„ä¼°ç»“æœæ—¶æ˜¾ç¤ºï¼‰ -->
                    <button
                        x-show="!pronunciationResult"
                        @click="skipPronunciation()"
                        class="px-4 py-2 bg-slate-700/50 text-slate-400 rounded-lg hover:bg-slate-600/50 transition"
                    >
                        è·³è¿‡
                    </button>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’®ï¼ˆè·Ÿè¯»ç»ƒä¹ æ—¶éšè—ï¼‰ -->
        <div x-show="!showPronunciationUI" class="grid grid-cols-2 gap-4 mt-4">
            <button
                @click="skipWord"
                :disabled="inputDisabled && !showResult"
                class="py-4 bg-slate-700/50 text-slate-300 rounded-xl font-medium hover:bg-slate-600/50 transition border border-slate-600 disabled:opacity-50"
            >
                è·³è¿‡
            </button>
            <button
                @click="showResult ? nextWord() : submitAnswer()"
                :disabled="(!userInput && !showResult) || (showResult && audioPlaying)"
                class="py-4 bg-gradient-to-r from-sky-500 to-blue-500 text-white rounded-xl font-medium hover:from-sky-600 hover:to-blue-600 transition shadow-lg shadow-blue-500/20 disabled:opacity-50 disabled:shadow-none"
            >
                <span x-text="showResult ? (audioPlaying ? 'æ’­æ”¾ä¸­...' : 'ä¸‹ä¸€ä¸ª') : 'ç¡®è®¤'"></span>
            </button>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/recorder.js"></script>
<script>
// ç¿»è¯‘åˆ†å±‚æ˜¾ç¤ºå‡½æ•°
function splitTranslation(translation) {
    if (!translation) return { main: '', extended: '' };

    const parts = translation.split('ï¼›');
    const mainParts = [];
    const extParts = [];

    for (const part of parts) {
        const trimmed = part.trim();
        if (/^\[.+?\]/.test(trimmed)) {
            extParts.push(trimmed);
        } else {
            mainParts.push(trimmed);
        }
    }

    return {
        main: mainParts.join('ï¼›') || extParts.shift() || '',
        extended: extParts.join('ï¼›')
    };
}

function dictationPage() {
    // è¯ä¹¦ ID æ˜ å°„è¡¨ï¼ˆä»æœåŠ¡ç«¯è·å–ï¼‰
    const bookNames = {
        {% for book in books %}
        '{{ book.id }}': '{{ book.name }}',
        {% endfor %}
    };

    return {
        bookId: {% if book_id %}'{{ book_id }}'{% else %}null{% endif %},  // å…¨å±€å¤ä¹ æ—¶ä¸º null
        urlParams: new URLSearchParams(window.location.search),
        mode: '',
        unit: '',
        limit: 20,
        loading: true,
        finished: false,
        showPhonetic: false,

        cards: [],
        currentIndex: 0,
        currentCard: null,

        // è·å–è¯ä¹¦åç§°
        getBookName(bookId) {
            return bookNames[bookId] || bookId || 'æœªçŸ¥';
        },

        userInput: '',
        inputs: [],  // è®°å½•æ‰€æœ‰è¾“å…¥
        attempt: 0,
        maxAttempts: 3,

        hint: '',
        showResult: false,
        showAnswer: false,
        isCorrect: false,
        inputDisabled: false,
        remainingAttempts: 3,

        // éŸ³è‰²å’Œè¯­é€Ÿï¼ˆAlpine å“åº”å¼çŠ¶æ€ï¼ŒåŒæ­¥åˆ° TTS æ¨¡å—ï¼‰
        currentVoice: TTS.getVoice(),
        currentSpeed: TTS.getSpeed(),

        exampleSentence: '',
        exampleChinese: '',

        correctCount: 0,
        wrongCount: 0,

        // éŸ³é¢‘æ’­æ”¾å™¨
        audioPlayer: null,
        audioPlaying: false,  // éŸ³é¢‘æ˜¯å¦æ­£åœ¨æ’­æ”¾

        // è·Ÿè¯»å‘éŸ³è¯„ä¼°
        showPronunciationUI: false,      // æ˜¾ç¤ºè·Ÿè¯»ç•Œé¢
        isRecordingPronunciation: false, // å½•éŸ³ä¸­
        pronunciationResult: null,        // è¯„ä¼°ç»“æœ
        pronunciationFeedback: '',        // åé¦ˆæ–‡æœ¬
        pronunciationAttempt: 0,          // è·Ÿè¯»æ¬¡æ•°
        maxPronunciationAttempts: 2,      // æœ€å¤šè·Ÿè¯»æ¬¡æ•°
        pronunciationRecorder: null,      // å½•éŸ³å™¨å®ä¾‹
        pronunciationSubmitting: false,   // æ­£åœ¨æäº¤è¯„ä¼°
        practiceWordAudioCache: {},       // ç»ƒä¹ å•è¯éŸ³é¢‘ç¼“å­˜

        async init() {
            // ä» URL è¯»å–å‚æ•°
            this.mode = this.urlParams.get('mode') || 'review';
            this.unit = this.urlParams.get('unit') || '';
            const limitParam = this.urlParams.get('limit');
            this.limit = limitParam ? parseInt(limitParam) : 20;
            // limit=0 è¡¨ç¤ºå…¨éƒ¨
            if (this.limit === 0) this.limit = 9999;

            await this.loadCards();
            this.loading = false;
            if (this.cards.length > 0) {
                this.showCard(0);
            }

            // å…¨å±€é”®ç›˜ç›‘å¬ï¼šå›è½¦é”®
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (this.showResult && !this.audioPlaying) {
                        // æ˜¾ç¤ºç»“æœä¸”éŸ³é¢‘æ’­æ”¾å®Œæ¯•æ—¶ï¼Œå›è½¦è¿›å…¥ä¸‹ä¸€ä¸ª
                        this.nextWord();
                    } else if (this.userInput && !this.inputDisabled) {
                        // æœ‰è¾“å…¥ä¸”æœªç¦ç”¨æ—¶ï¼Œæäº¤ç­”æ¡ˆ
                        this.submitAnswer();
                    }
                }
            });
        },

        async loadCards() {
            try {
                // æ„å»ºè¯·æ±‚ä½“ï¼Œå…¨å±€å¤ä¹ æ—¶ä¸ä¼  book_id
                const requestBody = {
                    mode: this.mode,
                    limit: this.limit
                };
                if (this.bookId) {
                    requestBody.book_id = this.bookId;
                }
                if (this.unit) {
                    requestBody.unit = this.unit;
                }

                const response = await fetch('/api/session/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                if (response.ok) {
                    const data = await response.json();
                    this.cards = data.cards;
                }
            } catch (e) {
                console.error('åŠ è½½å•è¯å¤±è´¥:', e);
            }
        },

        showCard(index) {
            if (index >= this.cards.length) {
                this.finished = true;
                return;
            }
            this.currentIndex = index;
            this.currentCard = this.cards[index];
            this.userInput = '';
            this.inputs = [];
            this.attempt = 0;
            this.hint = '';
            this.showResult = false;
            this.showAnswer = false;
            this.isCorrect = false;
            this.inputDisabled = false;
            this.remainingAttempts = this.maxAttempts;
            this.exampleSentence = '';
            this.exampleChinese = '';

            // é‡ç½®è·Ÿè¯»çŠ¶æ€
            this.showPronunciationUI = false;
            this.isRecordingPronunciation = false;
            this.pronunciationResult = null;
            this.pronunciationFeedback = '';
            this.pronunciationAttempt = 0;
            this.pronunciationSubmitting = false;

            // æ¸…é™¤ç»ƒä¹ å•è¯éŸ³é¢‘ç¼“å­˜
            Object.values(this.practiceWordAudioCache).forEach(howl => howl.unload());
            this.practiceWordAudioCache = {};

            // èšç„¦è¾“å…¥æ¡†
            this.$nextTick(() => {
                this.$refs.inputField?.focus();
            });
        },

        async submitAnswer() {
            if (!this.userInput.trim() || this.inputDisabled) return;

            this.attempt++;
            this.inputs.push(this.userInput.trim());

            // æ£€æŸ¥ç­”æ¡ˆï¼ˆbook_id ä» currentCard è·å–ï¼Œæ”¯æŒå…¨å±€å¤ä¹ ï¼‰
            const cardBookId = this.currentCard.book_id || this.bookId;
            const response = await fetch('/api/session/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    word: this.currentCard.word,
                    input: this.userInput.trim(),
                    attempt: this.attempt,
                    book_id: cardBookId
                })
            });

            if (!response.ok) return;

            const result = await response.json();
            this.isCorrect = result.correct;
            this.remainingAttempts = result.remaining_attempts;

            if (this.isCorrect) {
                // æ­£ç¡®
                this.showResult = true;
                this.inputDisabled = true;
                this.correctCount++;

                // å¼‚æ­¥ä¿å­˜ï¼Œä¸é˜»å¡ UI
                this.completeWord(true, false);

                // è§¦å‘è·Ÿè¯»ç»ƒä¹ 
                await this.startPronunciationPractice();
            } else {
                // é”™è¯¯å¤„ç†
                if (this.attempt === 1) {
                    // ç¬¬1æ¬¡é”™è¯¯ï¼šæ˜¾ç¤ºæç¤ºï¼Œå¹¶è‡ªåŠ¨æ’­æ”¾ä¸€æ¬¡å•è¯å‘éŸ³ï¼ˆç”¨å½“å‰è¯­é€Ÿï¼‰
                    this.hint = result.hint;
                    this.userInput = '';
                    TTS.playWord(this.currentCard.word);
                } else if (this.attempt === 2) {
                    // ç¬¬2æ¬¡é”™è¯¯ï¼šæ’­æ”¾æ…¢é€Ÿå‘éŸ³
                    this.hint = 'é”™è¯¯ï¼Œå¬ä¸€ä¸‹å‘éŸ³';
                    TTS.playWord(this.currentCard.word, '0.5x');
                    this.userInput = '';
                } else {
                    // ç¬¬3æ¬¡é”™è¯¯ï¼šæ˜¾ç¤ºç­”æ¡ˆ
                    this.showResult = true;
                    this.showAnswer = true;
                    this.inputDisabled = true;
                    this.wrongCount++;
                    this.hint = '';

                    // å¼‚æ­¥ä¿å­˜ï¼Œä¸é˜»å¡ UI
                    this.completeWord(false, false);

                    // è§¦å‘è·Ÿè¯»ç»ƒä¹ 
                    await this.startPronunciationPractice();
                }
            }
        },

        async skipWord() {
            if (this.showResult) {
                this.nextWord();
                return;
            }

            this.inputs.push('[skipped]');
            this.showResult = true;
            this.showAnswer = true;
            this.inputDisabled = true;
            this.wrongCount++;
            this.hint = '';

            // å¼‚æ­¥ä¿å­˜ï¼Œä¸é˜»å¡ UI
            this.completeWord(false, true);

            // è§¦å‘è·Ÿè¯»ç»ƒä¹ 
            await this.startPronunciationPractice();
        },

        async completeWord(correct, skipped) {
            try {
                // book_id ä» currentCard è·å–ï¼Œæ”¯æŒå…¨å±€å¤ä¹ 
                const cardBookId = this.currentCard.book_id || this.bookId;
                await fetch('/api/session/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        word: this.currentCard.word,
                        book_id: cardBookId,
                        correct: correct,
                        attempts: this.attempt,
                        inputs: this.inputs,
                        skipped: skipped
                    })
                });
            } catch (e) {
                console.error('ä¿å­˜å¤±è´¥:', e);
            }
        },

        async loadExample() {
            try {
                const response = await fetch('/api/example-sentence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        word: this.currentCard.word,
                        translation: this.currentCard.translation
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.sentence) {
                        this.exampleSentence = data.sentence;
                        this.exampleChinese = data.chinese || '';
                        // æ’­æ”¾ä¾‹å¥ï¼Œé˜»æ­¢ä¸‹ä¸€æ­¥ç›´åˆ°æ’­æ”¾å®Œæ¯•
                        this.playSentenceAudio(data.sentence);
                        return true;  // æˆåŠŸè·å–ä¾‹å¥
                    } else if (data.error) {
                        // API è¿”å›é”™è¯¯ï¼ˆå¦‚ DeepSeek æœªé…ç½®ï¼‰
                        console.log('ä¾‹å¥æœåŠ¡ä¸å¯ç”¨:', data.error);
                    }
                }
            } catch (e) {
                console.error('è·å–ä¾‹å¥å¤±è´¥:', e);
            }
            return false;  // æœªè·å–åˆ°ä¾‹å¥
        },

        nextWord() {
            this.showCard(this.currentIndex + 1);
        },

        playAudio(speed) {
            if (!this.currentCard) return;
            TTS.playWord(this.currentCard.word, speed);
        },

        playVoice(voiceId) {
            if (!this.currentCard) return;
            this.currentVoice = voiceId;
            TTS.setVoice(voiceId);
            TTS.playWord(this.currentCard.word);
        },

        playSentenceAudio(sentence) {
            this.audioPlaying = true;
            TTS.playSentence(sentence).finally(() => {
                this.audioPlaying = false;
            });
        },

        goBack() {
            window.location.href = '/';
        },

        // ========== è·Ÿè¯»å‘éŸ³è¯„ä¼°ç›¸å…³æ–¹æ³• ==========

        async startPronunciationPractice() {
            // æ’­æ”¾æ ‡å‡†å‘éŸ³ï¼ˆé¢†è¯»ï¼‰
            await this.playAudioAndWait('normal');

            // æ˜¾ç¤ºè·Ÿè¯» UI
            this.showPronunciationUI = true;
            this.pronunciationAttempt = 0;
            this.pronunciationResult = null;
            this.pronunciationFeedback = 'è¯·è·Ÿè¯»è¿™ä¸ªå•è¯';
        },

        async playAudioAndWait(speed) {
            if (!this.currentCard) return;
            this.audioPlaying = true;
            try {
                await TTS.playWord(this.currentCard.word, speed);
            } catch (e) {
                console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
            } finally {
                this.audioPlaying = false;
            }
        },

        async togglePronunciationRecording() {
            if (this.isRecordingPronunciation) {
                await this.stopRecordingPronunciation();
            } else {
                await this.startRecordingPronunciation();
            }
        },

        async startRecordingPronunciation() {
            try {
                // åˆå§‹åŒ–å½•éŸ³å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (!this.pronunciationRecorder) {
                    this.pronunciationRecorder = new AudioRecorder();
                }
                await this.pronunciationRecorder.start();
                this.isRecordingPronunciation = true;
                this.pronunciationFeedback = 'å½•éŸ³ä¸­...';
            } catch (e) {
                console.error('å¯åŠ¨å½•éŸ³å¤±è´¥:', e);
                this.pronunciationFeedback = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™';
            }
        },

        async stopRecordingPronunciation() {
            if (!this.pronunciationRecorder) return;

            try {
                const audioBlob = await this.pronunciationRecorder.stop();
                this.isRecordingPronunciation = false;
                this.pronunciationFeedback = 'æ­£åœ¨è¯„ä¼°...';

                // æäº¤è¯„ä¼°
                await this.submitPronunciationAssessment(audioBlob);
            } catch (e) {
                console.error('åœæ­¢å½•éŸ³å¤±è´¥:', e);
                this.isRecordingPronunciation = false;
                this.pronunciationFeedback = 'å½•éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•';
            }
        },

        async submitPronunciationAssessment(audioBlob) {
            this.pronunciationSubmitting = true;
            this.pronunciationAttempt++;

            try {
                // æ£€æŸ¥å½•éŸ³æ•°æ®å¤§å°
                const blobSize = audioBlob.size;
                console.log(`[å½•éŸ³] éŸ³é¢‘å¤§å°: ${blobSize} bytes, ç±»å‹: ${audioBlob.type}`);

                if (blobSize < 1000) {
                    this.pronunciationFeedback = `å½•éŸ³æ—¶é—´å¤ªçŸ­ï¼ˆ${blobSize} bytesï¼‰ï¼Œè¯·æŒ‰ä½æŒ‰é’®è¯´å®Œæ•´ä¸ªå•è¯`;
                    return;
                }

                if (blobSize < 5000) {
                    console.warn(`[å½•éŸ³] éŸ³é¢‘æ•°æ®è¾ƒå° (${blobSize} bytes)ï¼Œå¯èƒ½å½±å“è¯†åˆ«æ•ˆæœ`);
                }

                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('word', this.currentCard.word);
                // book_id ä» currentCard è·å–ï¼Œæ”¯æŒå…¨å±€å¤ä¹ 
                formData.append('book_id', this.currentCard.book_id || this.bookId || '');

                const response = await fetch('/api/pronunciation/assess', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        this.pronunciationResult = data;
                        this.pronunciationFeedback = '';

                        // é¢„åŠ è½½ç»ƒä¹ å•è¯éŸ³é¢‘ï¼ˆä¸é˜»å¡ UIï¼‰
                        this.preloadPracticeWordAudios(data.practice_words);
                    } else {
                        // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                        const errorMsg = data.error || 'è¯„ä¼°å¤±è´¥';
                        console.error('[å½•éŸ³] æœåŠ¡ç«¯é”™è¯¯:', errorMsg);
                        this.pronunciationFeedback = `${errorMsg}ï¼Œè¯·é‡è¯•`;
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const detail = errorData.detail || errorData.error || `HTTP ${response.status}`;
                    console.error('[å½•éŸ³] è¯·æ±‚å¤±è´¥:', detail);
                    this.pronunciationFeedback = `${detail}ï¼Œè¯·é‡è¯•`;
                }
            } catch (e) {
                console.error('æäº¤è¯„ä¼°å¤±è´¥:', e);
                this.pronunciationFeedback = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
            } finally {
                this.pronunciationSubmitting = false;
            }
        },

        async replayPronunciationDemo() {
            await this.playAudioAndWait('normal');
        },

        // é¢„åŠ è½½ç»ƒä¹ å•è¯éŸ³é¢‘ï¼ˆåœ¨æ˜¾ç¤ºç»“æœæ—¶è°ƒç”¨ï¼Œä¸é˜»å¡ UIï¼‰
        preloadPracticeWordAudios(practiceWords) {
            if (!practiceWords || practiceWords.length === 0) return;

            practiceWords.forEach(pw => {
                const word = pw.word || pw;
                if (!word || this.practiceWordAudioCache[word]) return;

                const url = `/api/tts/normal/${encodeURIComponent(word)}`;
                // ä½¿ç”¨ Howl é¢„åŠ è½½ä½†ä¸æ’­æ”¾
                this.practiceWordAudioCache[word] = new Howl({
                    src: [url],
                    format: ['mp3'],
                    preload: true,
                    onloaderror: (id, err) => {
                        console.error(`é¢„åŠ è½½ ${word} éŸ³é¢‘å¤±è´¥:`, err);
                        delete this.practiceWordAudioCache[word];
                    }
                });
            });
        },

        async playPracticeWord(word) {
            // æ’­æ”¾æ¨èç»ƒä¹ å•è¯çš„å‘éŸ³
            if (this.audioPlaying) return;

            this.audioPlaying = true;

            // ä¼˜å…ˆä½¿ç”¨é¢„åŠ è½½ç¼“å­˜çš„éŸ³é¢‘
            const cachedHowl = this.practiceWordAudioCache[word];
            if (cachedHowl && cachedHowl.state() === 'loaded') {
                TTS.stop();  // åœæ­¢ç»Ÿä¸€ TTS æ’­æ”¾å™¨
                cachedHowl.off('end');
                cachedHowl.on('end', () => {
                    this.audioPlaying = false;
                });
                cachedHowl.play();
            } else {
                // ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨ç»Ÿä¸€ TTS æ¨¡å—
                try {
                    await TTS.playWord(word, 'normal');
                } catch (e) {
                    console.error('ç»ƒä¹ å•è¯éŸ³é¢‘åŠ è½½å¤±è´¥:', e);
                } finally {
                    this.audioPlaying = false;
                }
            }
        },

        skipPronunciation() {
            this.showPronunciationUI = false;
            this.nextWord();
        },

        async retryPronunciation() {
            this.pronunciationResult = null;
            this.pronunciationFeedback = 'è¯·å†æ¬¡è·Ÿè¯»';
            // å…ˆæ’­æ”¾ä¸€æ¬¡æ ‡å‡†å‘éŸ³
            await this.playAudioAndWait('normal');
        },

        continuePronunciation() {
            this.showPronunciationUI = false;
            this.nextWord();
        },

        // ========== ç»“æŸè·Ÿè¯»ç›¸å…³æ–¹æ³• ==========

        startConversationPractice() {
            // å°†å·²å­¦å•è¯å­˜å…¥ sessionStorageï¼ˆå¸¦é”™è¯¯ä¿æŠ¤ï¼‰
            const learnedWords = this.cards.map(card => ({
                word: card.word,
                translation: card.translation
            }));

            // æ ¹æ®å•è¯æ•°é‡è®¡ç®—å¯¹è¯è½®æ•°
            const wordCount = learnedWords.length;
            let rounds = 5;
            if (wordCount < 10) rounds = 3;
            else if (wordCount < 20) rounds = 5;
            else if (wordCount < 40) rounds = 7;
            else rounds = 10;

            try {
                sessionStorage.setItem('learnedWords', JSON.stringify(learnedWords));
                sessionStorage.setItem('conversationRounds', rounds);
            } catch (e) {
                console.error('ä¿å­˜ sessionStorage å¤±è´¥:', e);
            }

            // è·³è½¬åˆ°å¯¹è¯ç»ƒä¹ é¡µé¢ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªå•è¯çš„è¯ä¹¦æˆ–é»˜è®¤è¯ä¹¦ï¼‰
            const targetBookId = this.cards[0]?.book_id || this.bookId;
            if (targetBookId) {
                window.location.href = `/conversation/${targetBookId}`;
            } else {
                // å…¨å±€å¤ä¹ æ²¡æœ‰å›ºå®šè¯ä¹¦ï¼Œè¿”å›é¦–é¡µ
                window.location.href = '/';
            }
        }
    }
}
</script>
{% endblock %}
