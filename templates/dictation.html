{% extends "base.html" %}

{% block title %}Âê¨ÂÜôÁªÉ‰π† - Ëã±ËØ≠Â≠¶‰π†{% endblock %}

{% block body %}
<div class="min-h-screen bg-slate-900 flex flex-col" x-data="dictationPage()">
    <!-- È°∂ÈÉ®ÂØºËà™ -->
    <header class="bg-slate-800/80 backdrop-blur-sm shadow-lg border-b border-slate-700/50">
        <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
            <button @click="goBack" class="text-slate-400 hover:text-slate-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="text-center">
                <span class="font-medium text-slate-100">Âê¨ÂÜôÁªÉ‰π†</span>
                <div class="text-xs text-slate-400">
                    <span x-text="currentIndex + 1"></span> / <span x-text="cards.length"></span>
                </div>
            </div>
            <div class="w-6"></div>
        </div>
        <!-- ËøõÂ∫¶Êù° -->
        <div class="h-1 bg-slate-700/50">
            <div
                class="h-full bg-gradient-to-r from-sky-500 to-blue-500 transition-all duration-300"
                :style="`width: ${cards.length > 0 ? ((currentIndex) / cards.length * 100) : 0}%`"
            ></div>
        </div>
    </header>

    <!-- ÂÆûÊó∂Â≠¶‰π†ÁªüËÆ°Èù¢Êùø -->
    <div
        x-show="!loading && cards.length > 0 && !finished"
        x-cloak
        class="max-w-2xl mx-auto w-full px-4 pt-2"
    >
        <div
            @click="statsCollapsed = !statsCollapsed"
            class="bg-slate-800/40 backdrop-blur-sm border border-slate-700/30 rounded-xl cursor-pointer select-none overflow-hidden"
        >
            <!-- Êî∂Ëµ∑Áä∂ÊÄÅÔºöÂçïË°åÊëòË¶Å -->
            <div class="flex items-center justify-between py-2 px-3">
                <div class="flex items-center gap-3 text-xs">
                    <span class="flex items-center gap-1"
                          :class="isIdle ? 'text-amber-400' : 'text-slate-400'">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span x-text="formatTime()"></span>
                        <span x-show="isIdle" class="text-[10px]">(ÊöÇÂÅú)</span>
                    </span>
                    <span class="text-slate-600">|</span>
                    <span class="text-slate-400">
                        ÂÆåÊàê <span class="text-sky-300 font-medium" x-text="totalCompleted"></span>
                    </span>
                    <span class="text-slate-600">|</span>
                    <span class="text-slate-400">
                        È¶ñÊ¨° <span class="text-emerald-300 font-medium"
                                  x-text="totalCompleted > 0 ? Math.round(firstAttemptCorrect / totalCompleted * 100) + '%' : '-'"></span>
                    </span>
                </div>
                <svg class="w-4 h-4 text-slate-500 transition-transform duration-200 flex-shrink-0"
                     :class="{ 'rotate-180': !statsCollapsed }"
                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>

            <!-- Â±ïÂºÄÁä∂ÊÄÅÔºöËØ¶ÁªÜÁªüËÆ° -->
            <div x-show="!statsCollapsed"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="pb-3 px-3">
                <div class="grid grid-cols-5 gap-1.5 text-center">
                    <div class="bg-slate-700/30 rounded-lg py-2 px-1">
                        <div class="text-sm font-bold text-slate-200" x-text="formatTime()"></div>
                        <div class="text-[10px] text-slate-500 mt-0.5">Â≠¶‰π†Êó∂Èïø</div>
                    </div>
                    <div class="bg-slate-700/30 rounded-lg py-2 px-1">
                        <div class="text-sm font-bold text-sky-400" x-text="totalCompleted"></div>
                        <div class="text-[10px] text-slate-500 mt-0.5">Â∑≤ÂÆåÊàê</div>
                    </div>
                    <div class="bg-slate-700/30 rounded-lg py-2 px-1">
                        <div class="text-sm font-bold text-emerald-400"
                             x-text="totalCompleted > 0 ? Math.round(firstAttemptCorrect / totalCompleted * 100) + '%' : '-'"></div>
                        <div class="text-[10px] text-slate-500 mt-0.5">È¶ñÊ¨°Ê≠£Á°Æ</div>
                    </div>
                    <div class="bg-slate-700/30 rounded-lg py-2 px-1">
                        <div class="text-sm font-bold text-amber-400"
                             x-text="totalCompleted > 0 ? Math.round(secondAttemptCorrect / totalCompleted * 100) + '%' : '-'"></div>
                        <div class="text-[10px] text-slate-500 mt-0.5">‰∫åÊ¨°Ê≠£Á°Æ</div>
                    </div>
                    <div class="bg-slate-700/30 rounded-lg py-2 px-1">
                        <div class="text-sm font-bold text-rose-400"
                             x-text="totalCompleted > 0 ? Math.round(thirdAttemptCorrect / totalCompleted * 100) + '%' : '-'"></div>
                        <div class="text-[10px] text-slate-500 mt-0.5">‰∏âÊ¨°Ê≠£Á°Æ</div>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-x-3 gap-y-1 mt-2 text-[11px] text-slate-400">
                    <span>ËøûÁª≠ <span class="text-emerald-300" x-text="currentStreak"></span></span>
                    <span>ÊúÄ‰Ω≥ <span class="text-amber-300" x-text="bestStreak"></span></span>
                    <span>Ë∑≥Ëøá <span class="text-rose-300" x-text="skippedCount"></span></span>
                    <span>ÂùáÊ¨° <span class="text-sky-300" x-text="totalCompleted > 0 ? (totalAttempts / totalCompleted).toFixed(1) : '-'"></span></span>
                    <span>ÈÄüÂ∫¶ <span class="text-purple-300" x-text="elapsedActiveMs >= 60000 ? (totalCompleted / (elapsedActiveMs / 60000)).toFixed(1) + 'ËØç/ÂàÜ' : '-'"></span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Âä†ËΩΩ‰∏≠ -->
    <div x-show="loading" class="flex-1 flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-sky-500 border-t-transparent mx-auto"></div>
            <p class="text-slate-400 mt-4">Âä†ËΩΩ‰∏≠...</p>
        </div>
    </div>

    <!-- Êó†ÂçïËØç -->
    <div x-show="!loading && cards.length === 0" x-cloak class="flex-1 flex items-center justify-center p-4">
        <div class="text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 class="text-xl font-medium text-slate-200 mb-2">ÊöÇÊó†ÂçïËØç</h2>
            <p class="text-slate-400 mb-6">ÂΩìÂâçÊ≤°ÊúâÈúÄË¶ÅÂ≠¶‰π†ÁöÑÂçïËØç</p>
            <button @click="goBack" class="bg-gradient-to-r from-sky-500 to-blue-500 text-white px-6 py-2 rounded-lg shadow-lg shadow-blue-500/20">ËøîÂõû</button>
        </div>
    </div>

    <!-- Â≠¶‰π†ÂÆåÊàê -->
    <div x-show="!loading && finished" x-cloak class="flex-1 flex items-center justify-center p-4">
        <div class="text-center bg-slate-800/50 backdrop-blur rounded-2xl shadow-xl border border-slate-700/50 p-8 max-w-sm w-full">
            <div class="text-6xl mb-4">üéä</div>
            <h2 class="text-2xl font-bold text-slate-100 mb-2">Â≠¶‰π†ÂÆåÊàê!</h2>
            <div class="grid grid-cols-2 gap-4 my-6">
                <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3">
                    <div class="text-2xl font-bold text-emerald-400" x-text="correctCount"></div>
                    <div class="text-sm text-slate-400">Ê≠£Á°Æ</div>
                </div>
                <div class="bg-rose-500/10 border border-rose-500/20 rounded-lg p-3">
                    <div class="text-2xl font-bold text-rose-400" x-text="wrongCount"></div>
                    <div class="text-sm text-slate-400">ÈîôËØØ</div>
                </div>
            </div>
            <p class="text-slate-300 mb-4">
                Ê≠£Á°ÆÁéá: <span class="font-bold" x-text="Math.round(correctCount / (correctCount + wrongCount) * 100) || 0"></span>%
            </p>
            <!-- ËØ¶ÁªÜÂ≠¶‰π†ÁªüËÆ° -->
            <div class="border-t border-slate-700/50 pt-4 mb-6">
                <div class="grid grid-cols-3 gap-2 text-center mb-3">
                    <div class="bg-slate-700/30 rounded-lg p-2">
                        <div class="text-lg font-bold text-slate-200" x-text="formatTime()"></div>
                        <div class="text-[10px] text-slate-500">Â≠¶‰π†Êó∂Èïø</div>
                    </div>
                    <div class="bg-slate-700/30 rounded-lg p-2">
                        <div class="text-lg font-bold text-amber-400" x-text="bestStreak"></div>
                        <div class="text-[10px] text-slate-500">ÊúÄ‰Ω≥ËøûÁª≠</div>
                    </div>
                    <div class="bg-slate-700/30 rounded-lg p-2">
                        <div class="text-lg font-bold text-purple-400" x-text="elapsedActiveMs >= 60000 ? (totalCompleted / (elapsedActiveMs / 60000)).toFixed(1) : '-'"></div>
                        <div class="text-[10px] text-slate-500">ËØç/ÂàÜÈíü</div>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-x-3 gap-y-1 text-xs text-slate-400">
                    <span>È¶ñÊ¨° <span class="text-emerald-300 font-medium" x-text="firstAttemptCorrect"></span></span>
                    <span>‰∫åÊ¨° <span class="text-amber-300 font-medium" x-text="secondAttemptCorrect"></span></span>
                    <span>‰∏âÊ¨° <span class="text-rose-300 font-medium" x-text="thirdAttemptCorrect"></span></span>
                    <span>Ë∑≥Ëøá <span class="text-slate-300 font-medium" x-text="skippedCount"></span></span>
                    <span>ÂùáÊ¨° <span class="text-sky-300 font-medium" x-text="totalCompleted > 0 ? (totalAttempts / totalCompleted).toFixed(1) : '-'"></span></span>
                </div>
            </div>
            <!-- ÂØπËØùÁªÉ‰π†ÊåâÈíÆÔºà‰ªÖÂ≠¶Êñ∞ËØçÊ®°ÂºèÊòæÁ§∫Ôºâ -->
            <button
                x-show="mode === 'new' && cards.length >= 5"
                @click="startConversationPractice"
                class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-3 rounded-lg font-medium mb-3 shadow-lg shadow-orange-500/20 hover:from-amber-600 hover:to-orange-600 transition"
            >
                üé§ ÂºÄÂßãÂØπËØùÁªÉ‰π†
            </button>
            <button @click="goBack" class="w-full bg-gradient-to-r from-sky-500 to-blue-500 text-white py-3 rounded-lg font-medium shadow-lg shadow-blue-500/20 hover:from-sky-600 hover:to-blue-600 transition">ËøîÂõûÈ¶ñÈ°µ</button>
        </div>
    </div>

    <!-- Â≠¶‰π†ÁïåÈù¢ -->
    <main x-show="!loading && cards.length > 0 && !finished" x-cloak class="flex-1 flex flex-col max-w-2xl mx-auto w-full p-4">
        <!-- ÂçïËØçÂç°Áâá -->
        <div class="bg-slate-800/50 backdrop-blur rounded-2xl shadow-xl border border-slate-700/50 flex-1 flex flex-col p-6">
            <!-- ‰∏≠ÊñáÈáä‰πâ -->
            <div class="text-center" :class="showPronunciationUI ? 'py-3' : 'py-8'">
                <!-- Âº∫ÂåñËÆ∞ÂøÜÔºöÂΩ©Ëâ≤Èü≥ËäÇÊòæÁ§∫Âú®‰∏≠Êñá‰∏äÊñπ -->
                <div x-show="reinforceMode" x-cloak class="mb-4">
                    <div class="text-xs text-amber-400 mb-1">Âº∫ÂåñËÆ∞ÂøÜ (<span x-text="reinforceCount"></span>/2)</div>
                    <div class="text-3xl font-bold tracking-wider" x-html="reinforceSyllablesHtml"></div>
                </div>
                <div class="text-3xl font-bold text-slate-100" x-text="splitTranslation(currentCard?.translation || '').main"></div>
                <div class="text-sm text-slate-400 mt-2" x-show="splitTranslation(currentCard?.translation || '').extended" x-text="splitTranslation(currentCard?.translation || '').extended"></div>
                <div class="text-slate-500 mt-2" x-show="showPhonetic" x-text="currentCard?.phonetic || ''"></div>
                <!-- Â§ç‰π†Ê®°Âºè‰∏ãÊòæÁ§∫ËØç‰π¶Êù•Ê∫ê -->
                <div x-show="mode === 'review' && currentCard?.book_id" class="text-xs text-slate-500 mt-2">
                    Êù•Ëá™: <span x-text="getBookName(currentCard?.book_id)"></span>
                </div>
            </div>

            <!-- ËæìÂÖ•Âå∫Âüü -->
            <div class="flex flex-col justify-center" :class="showPronunciationUI ? '' : 'flex-1'">
                <!-- ÂçïËØçÂéÜÂè≤ÁªüËÆ° (‰ªÖÂ§ç‰π†Ê®°Âºè‰∏îÊúâÂéÜÂè≤ËÆ∞ÂΩïÊó∂ÊòæÁ§∫) -->
                <div
                    x-show="mode === 'review' && currentCard?.history_stats"
                    x-cloak
                    class="mb-3 text-center"
                >
                    <div class="inline-flex items-center gap-4 px-4 py-2 bg-slate-700/30 rounded-lg text-sm">
                        <span class="text-slate-400">
                            Â§ç‰π† <span class="text-sky-400 font-medium" x-text="currentCard?.history_stats?.total || 0"></span> Ê¨°
                        </span>
                        <span class="text-slate-600">|</span>
                        <span class="text-slate-400">
                            Á≠îÂØπ <span class="text-emerald-400 font-medium" x-text="currentCard?.history_stats?.correct || 0"></span> Ê¨°
                        </span>
                        <span class="text-slate-600">|</span>
                        <span class="text-slate-400">
                            ÈîôËØØ <span class="text-rose-400 font-medium" x-text="currentCard?.history_stats?.wrong || 0"></span> Ê¨°
                        </span>
                    </div>
                </div>
                <!-- ËæìÂÖ•Ê°Ü -->
                <div class="relative">
                    <input
                        type="text"
                        x-model="userInput"
                        :disabled="inputDisabled"
                        x-ref="inputField"
                        class="w-full text-center text-2xl py-4 bg-slate-700/50 border-2 border-slate-600 text-slate-100 rounded-xl focus:border-sky-500 focus:ring-0 outline-none transition disabled:bg-slate-700/30 disabled:text-slate-500"
                        :class="{
                            'border-emerald-500 bg-emerald-500/10': showResult && isCorrect,
                            'border-rose-500 bg-rose-500/10': showResult && !isCorrect
                        }"
                        placeholder="ËØ∑ËæìÂÖ•ÂçïËØç"
                        autocomplete="off"
                        autocapitalize="none"
                        spellcheck="false"
                    >
                    <!-- Ê≠£Á°Æ/ÈîôËØØÂõæÊ†á -->
                    <div x-show="showResult" class="absolute right-4 top-1/2 -translate-y-1/2">
                        <span x-show="isCorrect" class="text-emerald-400 text-2xl">‚úì</span>
                        <span x-show="!isCorrect" class="text-rose-400 text-2xl">‚úó</span>
                    </div>
                </div>

                <!-- ÊèêÁ§∫Âå∫Âüü -->
                <div :class="showPronunciationUI ? 'mt-1' : 'mt-4 min-h-[60px]'">
                    <!-- ÈîôËØØÊèêÁ§∫ -->
                    <div x-show="hint" x-cloak class="bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 text-center">
                        <span class="text-amber-400" x-text="hint"></span>
                        <span class="text-slate-400 text-sm ml-2" x-show="remainingAttempts > 0">
                            ËøòÊúâ <span x-text="remainingAttempts"></span> Ê¨°Êú∫‰ºö
                        </span>
                    </div>

                    <!-- ‰æãÂè•ÊèêÁ§∫ -->
                    <div x-show="exampleSentence" x-cloak class="bg-sky-500/10 border border-sky-500/30 rounded-lg p-3">
                        <div class="text-sky-300" x-text="exampleSentence"></div>
                        <div class="text-slate-400 text-sm mt-1" x-text="exampleChinese"></div>
                    </div>

                    <!-- Ê≠£Á°ÆÁ≠îÊ°à -->
                    <div x-show="showAnswer" x-cloak class="text-center">
                        <div class="text-slate-400 text-sm">Ê≠£Á°ÆÁ≠îÊ°à</div>
                        <div class="text-2xl font-bold text-slate-100 mt-1" x-text="currentCard?.word || ''"></div>
                        <div class="text-slate-500 text-sm mt-1" x-text="currentCard?.phonetic || ''"></div>
                    </div>
                </div>
            </div>

            <!-- Èü≥Ëâ≤ + ËØ≠ÈÄüÈÄâÊã© -->
            <div x-show="!showPronunciationUI" class="py-4">
                <!-- Âõõ‰∏™Èü≥Ëâ≤ÊåâÈíÆ -->
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <template x-for="v in TTS.voices" :key="v.id">
                        <button
                            @click="playVoice(v.id)"
                            :disabled="attempt === 0 && !showResult"
                            :class="currentVoice === v.id
                                ? 'bg-sky-500/30 border-sky-500/60 text-sky-300'
                                : 'bg-slate-700/50 border-slate-600 text-slate-300 hover:bg-slate-600/50'"
                            class="py-2 px-1 rounded-lg text-xs font-medium border transition disabled:opacity-40 disabled:cursor-not-allowed"
                            x-text="v.label"
                        ></button>
                    </template>
                </div>
                <!-- ‰∏â‰∏™ËØ≠ÈÄüÊåâÈíÆ -->
                <div class="flex justify-center gap-2">
                    <template x-for="s in TTS.speeds" :key="s.id">
                        <button
                            @click="currentSpeed = s.id; TTS.setSpeed(s.id)"
                            :class="currentSpeed === s.id
                                ? 'bg-amber-500/30 border-amber-500/60 text-amber-300'
                                : 'bg-slate-700/50 border-slate-600 text-slate-400 hover:bg-slate-600/50'"
                            class="px-4 py-1.5 rounded-lg text-xs font-medium border transition"
                            x-text="s.label"
                        ></button>
                    </template>
                </div>
            </div>

            <!-- Ë∑üËØªÂèëÈü≥ËØÑ‰º∞ÁïåÈù¢ÔºàËûçÂêàÂú®‰∏ªÂç°ÁâáÂÜÖÔºâ -->
            <div x-show="showPronunciationUI" x-cloak class="mt-2 bg-purple-500/10 border border-purple-500/30 rounded-xl overflow-hidden">
                <div class="flex flex-row min-h-[160px]">
                    <!-- Â∑¶‰æß‰π¶Á≠æÔºöË∑üËØªÁªÉ‰π†Á´ñÊéí -->
                    <div class="flex-shrink-0 w-9 bg-gradient-to-b from-purple-600/40 to-purple-800/40 border-r border-purple-500/30 flex items-center justify-center">
                        <div class="text-purple-200 text-sm font-bold tracking-[0.25em]" style="writing-mode: vertical-rl;">Ë∑üËØªÁªÉ‰π†</div>
                    </div>

                    <!-- ‰∏≠Èó¥‰∏ª‰Ωì -->
                    <div class="flex-1 min-w-0 p-4">
                        <!-- ÂçïËØçÔºàÂ±Ö‰∏≠Ôºâ -->
                        <div class="text-2xl font-bold text-slate-100 text-center mb-1" x-text="currentCard?.word || ''"></div>
                        <div class="text-slate-400 text-sm text-center" x-text="currentCard?.phonetic || ''"></div>

                        <!-- ÂèçÈ¶àÊñáÊú¨ÔºàÂΩïÈü≥ÂâçÊòæÁ§∫ÊèêÁ§∫ËØ≠Ôºâ -->
                        <div x-show="!pronunciationResult?.success" class="text-slate-400 text-sm mt-3 text-center" x-text="pronunciationFeedback || 'ËØ∑Ë∑üËØªËøô‰∏™ÂçïËØç'"></div>

                        <!-- ÂΩïÈü≥ÂâçÈü≥Ëâ≤ÊåâÈíÆ -->
                        <div x-show="!pronunciationResult?.success" class="grid grid-cols-4 gap-2 mt-3">
                            <template x-for="v in TTS.voices" :key="'pre-'+v.id">
                                <button
                                    @click="playVoice(v.id)"
                                    :disabled="audioPlaying || isRecordingPronunciation"
                                    :class="currentVoice === v.id
                                        ? 'bg-sky-500/30 border-sky-500/60 text-sky-300'
                                        : 'bg-slate-700/50 border-slate-600 text-slate-300 hover:bg-slate-600/50'"
                                    class="py-1.5 px-1 rounded-lg text-xs font-medium border transition disabled:opacity-40 disabled:cursor-not-allowed"
                                    x-text="v.label"
                                ></button>
                            </template>
                        </div>

                        <!-- ËØÑ‰º∞ÁªìÊûú‰∏≠ÁöÑÂàÜÊûêÂÜÖÂÆπ -->
                        <div x-show="pronunciationResult?.success">
                            <!-- ËØÜÂà´ÊñáÊú¨ -->
                            <div x-show="pronunciationResult?.recognized_text" class="mt-2 text-slate-400 text-sm text-center">
                                ËØÜÂà´: <span class="text-slate-300" x-text="pronunciationResult?.recognized_text"></span>
                            </div>

                            <!-- Â≠óÊØç-Èü≥Á¥†ÂØπÁÖßÂàÜÊûê -->
                            <div x-show="pronunciationResult?.letter_mapping?.length > 0" class="mt-2">
                                <div class="text-xs text-slate-400 mb-1 text-center">ÂèëÈü≥ÂàÜÊûê</div>
                                <div class="flex flex-wrap justify-center gap-1 mb-1">
                                    <template x-for="(m, i) in pronunciationResult?.letter_mapping || []" :key="'letter-'+i">
                                        <span
                                            class="px-2 py-1 rounded text-base font-bold cursor-default"
                                            :class="{
                                                'bg-emerald-500/20 text-emerald-300': m.accuracy >= 80,
                                                'bg-amber-500/20 text-amber-300': m.accuracy >= 60 && m.accuracy < 80,
                                                'bg-rose-500/20 text-rose-300': m.accuracy !== null && m.accuracy < 60,
                                                'bg-slate-700/50 text-slate-400': m.accuracy === null
                                            }"
                                            :title="m.accuracy !== null ? 'ÂáÜÁ°ÆÂ∫¶: ' + Math.round(m.accuracy) + '%' : ''"
                                            x-text="m.letter"
                                        ></span>
                                    </template>
                                </div>
                                <div class="flex flex-wrap justify-center gap-1">
                                    <template x-for="(m, i) in pronunciationResult?.letter_mapping || []" :key="'phoneme-'+i">
                                        <span
                                            class="px-2 py-0.5 text-xs font-mono text-slate-500"
                                            :style="'min-width: ' + (m.letter.length * 0.6 + 1) + 'rem'"
                                            x-text="m.phoneme || ''"
                                        ></span>
                                    </template>
                                </div>
                                <div x-show="pronunciationResult?.letter_mapping?.filter(m => m.accuracy !== null && m.accuracy < 60).length > 0"
                                     class="mt-1 text-xs text-rose-400 text-center">
                                    ÈúÄË¶ÅÊ≥®ÊÑè: <span x-text="pronunciationResult?.letter_mapping?.filter(m => m.accuracy !== null && m.accuracy < 60).map(m => m.letter + ' /' + m.phoneme + '/').join(', ')"></span>
                                </div>
                            </div>

                            <!-- ÊóßÁâàÈü≥Á¥†ËØ¶ÊÉÖÔºàÂêéÂ§áÔºâ -->
                            <div x-show="!pronunciationResult?.letter_mapping?.length && pronunciationResult?.phoneme_details?.length > 0" class="mt-2">
                                <div class="text-xs text-slate-400 mb-1 text-center">Èü≥Á¥†ÂàÜÊûê</div>
                                <div class="flex flex-wrap justify-center gap-1">
                                    <template x-for="(p, i) in pronunciationResult?.phoneme_details || []" :key="i">
                                        <span
                                            class="px-2 py-1 rounded text-sm font-mono cursor-default"
                                            :class="{
                                                'bg-emerald-500/20 text-emerald-300': p.accuracy >= 80,
                                                'bg-amber-500/20 text-amber-300': p.accuracy >= 60 && p.accuracy < 80,
                                                'bg-rose-500/20 text-rose-300': p.accuracy < 60
                                            }"
                                            :title="'ÂáÜÁ°ÆÂ∫¶: ' + Math.round(p.accuracy) + '%'"
                                            x-text="p.phoneme"
                                        ></span>
                                    </template>
                                </div>
                            </div>

                            <!-- Èü≥Ëâ≤ÊåâÈíÆ -->
                            <div class="grid grid-cols-4 gap-2 mt-3">
                                <template x-for="v in TTS.voices" :key="'pron-'+v.id">
                                    <button
                                        @click="playVoice(v.id)"
                                        :disabled="audioPlaying || isRecordingPronunciation"
                                        :class="currentVoice === v.id
                                            ? 'bg-sky-500/30 border-sky-500/60 text-sky-300'
                                            : 'bg-slate-700/50 border-slate-600 text-slate-300 hover:bg-slate-600/50'"
                                        class="py-1.5 px-1 rounded-lg text-xs font-medium border transition disabled:opacity-40 disabled:cursor-not-allowed"
                                        x-text="v.label"
                                    ></button>
                                </template>
                            </div>

                            <!-- ÂèçÈ¶àÊñáÊú¨ÔºàËØÑ‰º∞ÂêéÔºâ -->
                            <div class="text-slate-300 text-sm mt-2 text-center" x-text="pronunciationFeedback"></div>

                            <!-- ÂèëÈü≥ÊäÄÂ∑ßÊèêÁ§∫ -->
                            <div x-show="pronunciationResult?.tips" class="text-xs text-amber-400/80 mt-1 text-center">
                                <span class="inline-flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span x-text="pronunciationResult?.tips"></span>
                                </span>
                            </div>
                        </div>

                        <!-- Êé®ËçêÁªÉ‰π†ÂçïËØç -->
                        <div x-show="pronunciationResult?.practice_words?.length > 0" class="mt-3 p-3 bg-indigo-500/10 border border-indigo-500/30 rounded-lg">
                            <div class="text-xs text-indigo-300 mb-2 text-center">
                                <span x-show="pronunciationResult?.focus_phoneme">
                                    ÁªÉ‰π† /<span x-text="pronunciationResult?.focus_phoneme"></span>/ Èü≥Ôºö
                                </span>
                                <span x-show="!pronunciationResult?.focus_phoneme">Êé®ËçêÁªÉ‰π†Ôºö</span>
                            </div>
                            <div class="flex flex-col gap-2">
                                <template x-for="(pw, i) in pronunciationResult?.practice_words || []" :key="'pw-'+i">
                                    <button
                                        @click="playPracticeWord(pw.word || pw)"
                                        :disabled="audioPlaying"
                                        class="px-4 py-2 bg-indigo-500/20 text-indigo-200 rounded-lg hover:bg-indigo-500/30 transition disabled:opacity-50 flex items-center gap-3"
                                    >
                                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                                        </svg>
                                        <span class="font-medium" x-text="pw.word || pw"></span>
                                        <span x-show="pw.pos" class="text-xs text-indigo-400" x-text="pw.pos"></span>
                                        <span x-show="pw.meaning" class="text-xs text-gray-400" x-text="pw.meaning"></span>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Âè≥Ê†èÔºöÂΩïÈü≥/ËØÑÂàÜ -->
                    <div class="flex-shrink-0 w-32 border-l border-purple-500/20 bg-slate-800/30 flex flex-col items-center justify-center p-3 gap-3">
                        <!-- ÂΩïÈü≥ÂâçÔºöÂΩïÈü≥ÊåâÈíÆ + Ë∑≥Ëøá -->
                        <div x-show="!pronunciationResult?.success" class="flex flex-col items-center gap-3">
                            <button
                                @click="togglePronunciationRecording()"
                                :disabled="pronunciationSubmitting || audioPlaying"
                                class="w-14 h-14 rounded-full flex items-center justify-center transition-all duration-300 disabled:opacity-50"
                                :class="{
                                    'bg-rose-500 hover:bg-rose-600 animate-pulse': isRecordingPronunciation,
                                    'bg-purple-500 hover:bg-purple-600': !isRecordingPronunciation
                                }"
                            >
                                <svg x-show="!isRecordingPronunciation" class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                                <svg x-show="isRecordingPronunciation" class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                                </svg>
                            </button>
                            <button
                                x-show="!pronunciationResult"
                                @click="skipPronunciation()"
                                class="px-3 py-1.5 bg-slate-700/50 text-slate-400 rounded-lg hover:bg-slate-600/50 transition text-sm"
                            >
                                Ë∑≥Ëøá
                            </button>
                        </div>

                        <!-- ÂΩïÈü≥ÂêéÔºöËØÑÂàÜ + ÂΩïÈü≥ÊåâÈíÆ + Êìç‰ΩúÊåâÈíÆ -->
                        <div x-show="pronunciationResult?.success" class="flex flex-col items-center gap-3">
                            <!-- ‰∏âÈ°πËØÑÂàÜÁ´ñÊéí -->
                            <div class="space-y-1.5 text-sm w-full">
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400 text-xs">ÂáÜÁ°ÆÂ∫¶</span>
                                    <span class="font-bold"
                                        :class="{
                                            'text-emerald-400': pronunciationResult?.accuracy_score >= 75,
                                            'text-amber-400': pronunciationResult?.accuracy_score >= 60 && pronunciationResult?.accuracy_score < 75,
                                            'text-rose-400': pronunciationResult?.accuracy_score < 60
                                        }"
                                        x-text="Math.round(pronunciationResult?.accuracy_score || 0) + '%'"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400 text-xs">ÊµÅÁïÖÂ∫¶</span>
                                    <span class="font-bold"
                                        :class="{
                                            'text-emerald-400': pronunciationResult?.fluency_score >= 75,
                                            'text-amber-400': pronunciationResult?.fluency_score >= 60 && pronunciationResult?.fluency_score < 75,
                                            'text-rose-400': pronunciationResult?.fluency_score < 60
                                        }"
                                        x-text="Math.round(pronunciationResult?.fluency_score || 0) + '%'"></span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-400 text-xs">ÂÆåÊï¥Â∫¶</span>
                                    <span class="font-bold"
                                        :class="{
                                            'text-emerald-400': pronunciationResult?.completeness_score >= 75,
                                            'text-amber-400': pronunciationResult?.completeness_score >= 60 && pronunciationResult?.completeness_score < 75,
                                            'text-rose-400': pronunciationResult?.completeness_score < 60
                                        }"
                                        x-text="Math.round(pronunciationResult?.completeness_score || 0) + '%'"></span>
                                </div>
                            </div>

                            <!-- ÂΩïÈü≥ÊåâÈíÆ -->
                            <button
                                @click="togglePronunciationRecording()"
                                :disabled="pronunciationSubmitting || audioPlaying"
                                class="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300 disabled:opacity-50"
                                :class="{
                                    'bg-rose-500 hover:bg-rose-600 animate-pulse': isRecordingPronunciation,
                                    'bg-purple-500 hover:bg-purple-600': !isRecordingPronunciation
                                }"
                            >
                                <svg x-show="!isRecordingPronunciation" class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                                <svg x-show="isRecordingPronunciation" class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                                </svg>
                            </button>

                            <!-- ÂÜçËØï‰∏ÄÊ¨° / ÁªßÁª≠ -->
                            <div class="flex flex-col gap-1.5 w-full">
                                <button
                                    x-show="pronunciationResult && pronunciationAttempt < maxPronunciationAttempts"
                                    @click="retryPronunciation()"
                                    :disabled="audioPlaying || isRecordingPronunciation"
                                    class="w-full py-1.5 bg-amber-500/20 text-amber-300 rounded-lg hover:bg-amber-500/30 transition disabled:opacity-50 text-xs text-center"
                                >
                                    ÂÜçËØï‰∏ÄÊ¨°
                                </button>
                                <button
                                    x-show="pronunciationResult || pronunciationAttempt >= maxPronunciationAttempts"
                                    @click="continuePronunciation()"
                                    :disabled="audioPlaying"
                                    class="w-full py-1.5 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition disabled:opacity-50 text-xs text-center"
                                >
                                    ÁªßÁª≠
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Êìç‰ΩúÊåâÈíÆÔºàË∑üËØªÁªÉ‰π†Êó∂ÈöêËóèÔºâ -->
        <div x-show="!showPronunciationUI" class="grid grid-cols-2 gap-4 mt-4">
            <button
                @click="skipWord"
                :disabled="inputDisabled && !showResult"
                class="py-4 bg-slate-700/50 text-slate-300 rounded-xl font-medium hover:bg-slate-600/50 transition border border-slate-600 disabled:opacity-50"
            >
                Ë∑≥Ëøá
            </button>
            <button
                @click="showResult ? nextWord() : submitAnswer()"
                :disabled="(!userInput && !showResult) || (showResult && audioPlaying)"
                class="py-4 bg-gradient-to-r from-sky-500 to-blue-500 text-white rounded-xl font-medium hover:from-sky-600 hover:to-blue-600 transition shadow-lg shadow-blue-500/20 disabled:opacity-50 disabled:shadow-none"
            >
                <span x-text="showResult ? (audioPlaying ? 'Êí≠Êîæ‰∏≠...' : '‰∏ã‰∏Ä‰∏™') : 'Á°ÆËÆ§'"></span>
            </button>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/recorder.js"></script>
<script>
// ÁøªËØëÂàÜÂ±ÇÊòæÁ§∫ÂáΩÊï∞
function splitTranslation(translation) {
    if (!translation) return { main: '', extended: '' };

    const parts = translation.split('Ôºõ');
    const mainParts = [];
    const extParts = [];

    for (const part of parts) {
        const trimmed = part.trim();
        if (/^\[.+?\]/.test(trimmed)) {
            extParts.push(trimmed);
        } else {
            mainParts.push(trimmed);
        }
    }

    return {
        main: mainParts.join('Ôºõ') || extParts.shift() || '',
        extended: extParts.join('Ôºõ')
    };
}

function dictationPage() {
    // ËØç‰π¶ ID Êò†Â∞ÑË°®Ôºà‰ªéÊúçÂä°Á´ØËé∑ÂèñÔºâ
    const bookNames = {
        {% for book in books %}
        '{{ book.id }}': '{{ book.name }}',
        {% endfor %}
    };

    return {
        bookId: {% if book_id %}'{{ book_id }}'{% else %}null{% endif %},  // ÂÖ®Â±ÄÂ§ç‰π†Êó∂‰∏∫ null
        urlParams: new URLSearchParams(window.location.search),
        mode: '',
        unit: '',
        limit: 20,
        loading: true,
        finished: false,
        showPhonetic: false,

        cards: [],
        currentIndex: 0,
        currentCard: null,

        // Ëé∑ÂèñËØç‰π¶ÂêçÁß∞
        getBookName(bookId) {
            return bookNames[bookId] || bookId || 'Êú™Áü•';
        },

        userInput: '',
        inputs: [],  // ËÆ∞ÂΩïÊâÄÊúâËæìÂÖ•
        attempt: 0,
        maxAttempts: 3,

        hint: '',
        showResult: false,
        showAnswer: false,
        isCorrect: false,
        inputDisabled: false,
        remainingAttempts: 3,

        // Èü≥Ëâ≤ÂíåËØ≠ÈÄüÔºàAlpine ÂìçÂ∫îÂºèÁä∂ÊÄÅÔºåÂêåÊ≠•Âà∞ TTS Ê®°ÂùóÔºâ
        currentVoice: TTS.getVoice(),
        currentSpeed: TTS.getSpeed(),

        exampleSentence: '',
        exampleChinese: '',

        correctCount: 0,
        wrongCount: 0,

        // Â≠¶‰π†ÁªüËÆ°
        statsCollapsed: true,
        totalCompleted: 0,
        firstAttemptCorrect: 0,
        secondAttemptCorrect: 0,
        thirdAttemptCorrect: 0,
        skippedCount: 0,
        currentStreak: 0,
        bestStreak: 0,
        totalAttempts: 0,

        // Â≠¶‰π†ËÆ°Êó∂ÔºàÈîÆÁõòÁ©∫Èó≤Ë∂Ö1ÂàÜÈíüÊöÇÂÅúËÆ°Êó∂Ôºâ
        sessionStartTime: null,
        elapsedActiveMs: 0,
        timerInterval: null,
        lastActivityTime: null,
        isIdle: false,

        // Èü≥È¢ëÊí≠ÊîæÂô®
        audioPlayer: null,
        audioPlaying: false,  // Èü≥È¢ëÊòØÂê¶Ê≠£Âú®Êí≠Êîæ

        // Ë∑üËØªÂèëÈü≥ËØÑ‰º∞
        showPronunciationUI: false,      // ÊòæÁ§∫Ë∑üËØªÁïåÈù¢
        isRecordingPronunciation: false, // ÂΩïÈü≥‰∏≠
        pronunciationResult: null,        // ËØÑ‰º∞ÁªìÊûú
        pronunciationFeedback: '',        // ÂèçÈ¶àÊñáÊú¨
        pronunciationAttempt: 0,          // Ë∑üËØªÊ¨°Êï∞
        maxPronunciationAttempts: 2,      // ÊúÄÂ§öË∑üËØªÊ¨°Êï∞
        pronunciationRecorder: null,      // ÂΩïÈü≥Âô®ÂÆû‰æã
        pronunciationSubmitting: false,   // Ê≠£Âú®Êèê‰∫§ËØÑ‰º∞
        practiceWordAudioCache: {},       // ÁªÉ‰π†ÂçïËØçÈü≥È¢ëÁºìÂ≠ò

        // Âº∫ÂåñÂ≠¶‰π†Ê®°ÂºèÔºàÁ≠îÈîô3Ê¨°ÊàñË∑≥ËøáÂêéÔºâ
        reinforceMode: false,             // ÊòØÂê¶Â§Ñ‰∫éÂº∫ÂåñÂ≠¶‰π†Ê®°Âºè
        reinforceCount: 0,                // ÂΩìÂâçÊ≠£Á°ÆËΩÆÊï∞ÔºàÈúÄËææÂà∞2Ê¨°Ôºâ
        reinforceSyllables: [],           // Èü≥ËäÇÂàóË°®
        reinforceSyllablesHtml: '',       // ÂΩ©Ëâ≤Èü≥ËäÇ HTML

        formatTime() {
            const totalSec = Math.floor(this.elapsedActiveMs / 1000);
            const hours = Math.floor(totalSec / 3600);
            const mins = Math.floor((totalSec % 3600) / 60);
            const secs = totalSec % 60;
            if (hours > 0) {
                return `${hours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        },

        cleanupTimer() {
            if (this.timerInterval) { clearInterval(this.timerInterval); this.timerInterval = null; }
            if (this._idleChecker) { clearInterval(this._idleChecker); this._idleChecker = null; }
            if (this._activityHandler) {
                document.removeEventListener('keydown', this._activityHandler);
                document.removeEventListener('mousedown', this._activityHandler);
                document.removeEventListener('touchstart', this._activityHandler);
                this._activityHandler = null;
            }
        },

        async init() {
            // ‰ªé URL ËØªÂèñÂèÇÊï∞
            this.mode = this.urlParams.get('mode') || 'review';
            this.unit = this.urlParams.get('unit') || '';
            const limitParam = this.urlParams.get('limit');
            this.limit = limitParam ? parseInt(limitParam) : 20;
            // limit=0 Ë°®Á§∫ÂÖ®ÈÉ®
            if (this.limit === 0) this.limit = 9999;

            await this.loadCards();
            this.loading = false;
            if (this.cards.length > 0) {
                this.showCard(0);

                // ÂêØÂä®Â≠¶‰π†ËÆ°Êó∂Âô®
                this.sessionStartTime = Date.now();
                this.lastActivityTime = Date.now();
                this.isIdle = false;
                this.timerInterval = setInterval(() => {
                    if (!this.isIdle && !this.finished) {
                        this.elapsedActiveMs += 1000;
                    }
                }, 1000);

                // Á©∫Èó≤Ê£ÄÊµãÔºöÈîÆÁõò/Èº†Ê†á/Ëß¶Êë∏‰∫ã‰ª∂
                this._activityHandler = () => {
                    this.lastActivityTime = Date.now();
                    if (this.isIdle) this.isIdle = false;
                };
                document.addEventListener('keydown', this._activityHandler);
                document.addEventListener('mousedown', this._activityHandler);
                document.addEventListener('touchstart', this._activityHandler);

                // ÊØè5ÁßíÊ£ÄÊü•ÊòØÂê¶Á©∫Èó≤Ë∂ÖËøá60Áßí
                this._idleChecker = setInterval(() => {
                    if (!this.finished && Date.now() - this.lastActivityTime > 60000) {
                        this.isIdle = true;
                    }
                }, 5000);
            }

            // ÂÖ®Â±ÄÈîÆÁõòÁõëÂê¨ÔºöÂõûËΩ¶ÈîÆ
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (this.showResult && !this.audioPlaying) {
                        // ÊòæÁ§∫ÁªìÊûú‰∏îÈü≥È¢ëÊí≠ÊîæÂÆåÊØïÊó∂ÔºåÂõûËΩ¶ËøõÂÖ•‰∏ã‰∏Ä‰∏™
                        this.nextWord();
                    } else if (this.userInput && !this.inputDisabled) {
                        // ÊúâËæìÂÖ•‰∏îÊú™Á¶ÅÁî®Êó∂ÔºåÊèê‰∫§Á≠îÊ°à
                        this.submitAnswer();
                    }
                }
            });
        },

        async loadCards() {
            try {
                // ÊûÑÂª∫ËØ∑Ê±Ç‰ΩìÔºåÂÖ®Â±ÄÂ§ç‰π†Êó∂‰∏ç‰º† book_id
                const requestBody = {
                    mode: this.mode,
                    limit: this.limit
                };
                if (this.bookId) {
                    requestBody.book_id = this.bookId;
                }
                if (this.unit) {
                    requestBody.unit = this.unit;
                }

                const response = await fetch('/api/session/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                if (response.ok) {
                    const data = await response.json();
                    this.cards = data.cards;
                }
            } catch (e) {
                console.error('Âä†ËΩΩÂçïËØçÂ§±Ë¥•:', e);
            }
        },

        showCard(index) {
            if (index >= this.cards.length) {
                this.finished = true;
                this.cleanupTimer();
                return;
            }
            this.currentIndex = index;
            this.currentCard = this.cards[index];
            this.userInput = '';
            this.inputs = [];
            this.attempt = 0;
            this.hint = '';
            this.showResult = false;
            this.showAnswer = false;
            this.isCorrect = false;
            this.inputDisabled = false;
            this.remainingAttempts = this.maxAttempts;
            this.exampleSentence = '';
            this.exampleChinese = '';

            // ÈáçÁΩÆË∑üËØªÁä∂ÊÄÅ
            this.showPronunciationUI = false;
            this.isRecordingPronunciation = false;
            this.pronunciationResult = null;
            this.pronunciationFeedback = '';
            this.pronunciationAttempt = 0;
            this.pronunciationSubmitting = false;

            // ÈáçÁΩÆÂº∫ÂåñÂ≠¶‰π†Áä∂ÊÄÅ
            this.reinforceMode = false;
            this.reinforceCount = 0;
            this.reinforceSyllables = [];
            this.reinforceSyllablesHtml = '';

            // Ê∏ÖÈô§ÁªÉ‰π†ÂçïËØçÈü≥È¢ëÁºìÂ≠ò
            Object.values(this.practiceWordAudioCache).forEach(howl => howl.unload());
            this.practiceWordAudioCache = {};

            // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            this.$nextTick(() => {
                this.$refs.inputField?.focus();
            });
        },

        async submitAnswer() {
            if (!this.userInput.trim() || this.inputDisabled) return;

            // Âº∫ÂåñÂ≠¶‰π†Ê®°Âºè‰∏ã‰ΩøÁî®‰∏ìÁî®ÈÄªËæë
            if (this.reinforceMode) {
                await this.submitReinforceAnswer();
                return;
            }

            this.attempt++;
            this.inputs.push(this.userInput.trim());

            // Ê£ÄÊü•Á≠îÊ°àÔºàbook_id ‰ªé currentCard Ëé∑ÂèñÔºåÊîØÊåÅÂÖ®Â±ÄÂ§ç‰π†Ôºâ
            const cardBookId = this.currentCard.book_id || this.bookId;
            const response = await fetch('/api/session/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    word: this.currentCard.word,
                    input: this.userInput.trim(),
                    attempt: this.attempt,
                    book_id: cardBookId
                })
            });

            if (!response.ok) return;

            const result = await response.json();
            this.isCorrect = result.correct;
            this.remainingAttempts = result.remaining_attempts;

            if (this.isCorrect) {
                // Ê≠£Á°Æ
                this.showResult = true;
                this.inputDisabled = true;
                this.correctCount++;
                this.totalCompleted++;
                this.totalAttempts += this.attempt;
                if (this.attempt === 1) this.firstAttemptCorrect++;
                else if (this.attempt === 2) this.secondAttemptCorrect++;
                else if (this.attempt === 3) this.thirdAttemptCorrect++;
                this.currentStreak++;
                if (this.currentStreak > this.bestStreak) this.bestStreak = this.currentStreak;

                // ÂºÇÊ≠•‰øùÂ≠òÔºå‰∏çÈòªÂ°û UI
                this.completeWord(true, false);

                // Ëß¶ÂèëË∑üËØªÁªÉ‰π†
                await this.startPronunciationPractice();
            } else {
                // ÈîôËØØÂ§ÑÁêÜ
                if (this.attempt === 1) {
                    // Á¨¨1Ê¨°ÈîôËØØÔºöÊòæÁ§∫ÊèêÁ§∫ÔºåÂπ∂Ëá™Âä®Êí≠Êîæ‰∏ÄÊ¨°ÂçïËØçÂèëÈü≥ÔºàÁî®ÂΩìÂâçËØ≠ÈÄüÔºâ
                    this.hint = result.hint;
                    this.userInput = '';
                    TTS.playWord(this.currentCard.word);
                } else if (this.attempt === 2) {
                    // Á¨¨2Ê¨°ÈîôËØØÔºöÊí≠ÊîæÊ≠£Â∏∏ÂèëÈü≥
                    this.hint = 'ÈîôËØØÔºåÂê¨‰∏Ä‰∏ãÂèëÈü≥';
                    TTS.playWord(this.currentCard.word);
                    this.userInput = '';
                } else {
                    // Á¨¨3Ê¨°ÈîôËØØÔºöÊòæÁ§∫Á≠îÊ°àÔºåËøõÂÖ•Âº∫ÂåñÂ≠¶‰π†
                    this.showResult = true;
                    this.showAnswer = true;
                    this.inputDisabled = true;
                    this.wrongCount++;
                    this.totalCompleted++;
                    this.totalAttempts += 3;
                    this.currentStreak = 0;
                    this.hint = '';

                    // ÂºÇÊ≠•‰øùÂ≠òÔºå‰∏çÈòªÂ°û UI
                    this.completeWord(false, false);

                    // Ëß¶ÂèëÂº∫ÂåñÂ≠¶‰π†ÔºàÁ≠îÈîô3Ê¨°Ôºâ
                    await this.startReinforcementLearning();
                }
            }
        },

        async skipWord() {
            // Âº∫ÂåñÂ≠¶‰π†Ê®°Âºè‰∏ãË∑≥ËøáÔºöÁõ¥Êé•ËøõÂÖ•‰∏ã‰∏Ä‰∏™ÂçïËØç
            if (this.reinforceMode) {
                this.reinforceMode = false;
                this.nextWord();
                return;
            }

            if (this.showResult) {
                this.nextWord();
                return;
            }

            this.inputs.push('[skipped]');
            this.showResult = true;
            this.showAnswer = true;
            this.inputDisabled = true;
            this.wrongCount++;
            this.totalCompleted++;
            this.skippedCount++;
            this.currentStreak = 0;
            this.hint = '';

            // ÂºÇÊ≠•‰øùÂ≠òÔºå‰∏çÈòªÂ°û UI
            this.completeWord(false, true);

            // Ëß¶ÂèëÂº∫ÂåñÂ≠¶‰π†ÔºàË∑≥ËøáÔºâ
            await this.startReinforcementLearning();
        },

        async completeWord(correct, skipped) {
            try {
                // book_id ‰ªé currentCard Ëé∑ÂèñÔºåÊîØÊåÅÂÖ®Â±ÄÂ§ç‰π†
                const cardBookId = this.currentCard.book_id || this.bookId;
                await fetch('/api/session/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        word: this.currentCard.word,
                        book_id: cardBookId,
                        correct: correct,
                        attempts: this.attempt,
                        inputs: this.inputs,
                        skipped: skipped
                    })
                });
            } catch (e) {
                console.error('‰øùÂ≠òÂ§±Ë¥•:', e);
            }
        },

        async loadExample() {
            try {
                const response = await fetch('/api/example-sentence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        word: this.currentCard.word,
                        translation: this.currentCard.translation
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.sentence) {
                        this.exampleSentence = data.sentence;
                        this.exampleChinese = data.chinese || '';
                        // Êí≠Êîæ‰æãÂè•ÔºåÈòªÊ≠¢‰∏ã‰∏ÄÊ≠•Áõ¥Âà∞Êí≠ÊîæÂÆåÊØï
                        this.playSentenceAudio(data.sentence);
                        return true;  // ÊàêÂäüËé∑Âèñ‰æãÂè•
                    } else if (data.error) {
                        // API ËøîÂõûÈîôËØØÔºàÂ¶Ç DeepSeek Êú™ÈÖçÁΩÆÔºâ
                        console.log('‰æãÂè•ÊúçÂä°‰∏çÂèØÁî®:', data.error);
                    }
                }
            } catch (e) {
                console.error('Ëé∑Âèñ‰æãÂè•Â§±Ë¥•:', e);
            }
            return false;  // Êú™Ëé∑ÂèñÂà∞‰æãÂè•
        },

        nextWord() {
            this.showCard(this.currentIndex + 1);
        },

        playAudio(speed) {
            if (!this.currentCard) return;
            TTS.playWord(this.currentCard.word, speed);
        },

        playVoice(voiceId) {
            if (!this.currentCard) return;
            this.currentVoice = voiceId;
            TTS.setVoice(voiceId);
            TTS.playWord(this.currentCard.word);
        },

        playSentenceAudio(sentence) {
            this.audioPlaying = true;
            TTS.playSentence(sentence).finally(() => {
                this.audioPlaying = false;
            });
        },

        goBack() {
            this.cleanupTimer();
            window.location.href = '/';
        },

        // ========== Ë∑üËØªÂèëÈü≥ËØÑ‰º∞Áõ∏ÂÖ≥ÊñπÊ≥ï ==========

        async startPronunciationPractice() {
            // Êí≠ÊîæÊ†áÂáÜÂèëÈü≥ÔºàÈ¢ÜËØªÔºâ
            await this.playAudioAndWait('normal');

            // ÊòæÁ§∫Ë∑üËØª UI
            this.showPronunciationUI = true;
            this.pronunciationAttempt = 0;
            this.pronunciationResult = null;
            this.pronunciationFeedback = 'ËØ∑Ë∑üËØªËøô‰∏™ÂçïËØç';
        },

        async playAudioAndWait(speed) {
            if (!this.currentCard) return;
            this.audioPlaying = true;
            try {
                await TTS.playWord(this.currentCard.word, speed);
            } catch (e) {
                console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', e);
            } finally {
                this.audioPlaying = false;
            }
        },

        async togglePronunciationRecording() {
            if (this.isRecordingPronunciation) {
                await this.stopRecordingPronunciation();
            } else {
                await this.startRecordingPronunciation();
            }
        },

        async startRecordingPronunciation() {
            try {
                // ÂàùÂßãÂåñÂΩïÈü≥Âô®ÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                if (!this.pronunciationRecorder) {
                    this.pronunciationRecorder = new AudioRecorder();
                }
                await this.pronunciationRecorder.start();
                this.isRecordingPronunciation = true;
                this.pronunciationFeedback = 'ÂΩïÈü≥‰∏≠...';
            } catch (e) {
                console.error('ÂêØÂä®ÂΩïÈü≥Â§±Ë¥•:', e);
                this.pronunciationFeedback = 'Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôê';
            }
        },

        async stopRecordingPronunciation() {
            if (!this.pronunciationRecorder) return;

            try {
                const audioBlob = await this.pronunciationRecorder.stop();
                this.isRecordingPronunciation = false;
                this.pronunciationFeedback = 'Ê≠£Âú®ËØÑ‰º∞...';

                // Êèê‰∫§ËØÑ‰º∞
                await this.submitPronunciationAssessment(audioBlob);
            } catch (e) {
                console.error('ÂÅúÊ≠¢ÂΩïÈü≥Â§±Ë¥•:', e);
                this.isRecordingPronunciation = false;
                this.pronunciationFeedback = 'ÂΩïÈü≥Â§±Ë¥•ÔºåËØ∑ÈáçËØï';
            }
        },

        async submitPronunciationAssessment(audioBlob) {
            this.pronunciationSubmitting = true;
            this.pronunciationAttempt++;

            try {
                // Ê£ÄÊü•ÂΩïÈü≥Êï∞ÊçÆÂ§ßÂ∞è
                const blobSize = audioBlob.size;
                console.log(`[ÂΩïÈü≥] Èü≥È¢ëÂ§ßÂ∞è: ${blobSize} bytes, Á±ªÂûã: ${audioBlob.type}`);

                if (blobSize < 1000) {
                    this.pronunciationFeedback = `ÂΩïÈü≥Êó∂Èó¥Â§™Áü≠Ôºà${blobSize} bytesÔºâÔºåËØ∑Êåâ‰ΩèÊåâÈíÆËØ¥ÂÆåÊï¥‰∏™ÂçïËØç`;
                    return;
                }

                if (blobSize < 5000) {
                    console.warn(`[ÂΩïÈü≥] Èü≥È¢ëÊï∞ÊçÆËæÉÂ∞è (${blobSize} bytes)ÔºåÂèØËÉΩÂΩ±ÂìçËØÜÂà´ÊïàÊûú`);
                }

                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('word', this.currentCard.word);
                // book_id ‰ªé currentCard Ëé∑ÂèñÔºåÊîØÊåÅÂÖ®Â±ÄÂ§ç‰π†
                formData.append('book_id', this.currentCard.book_id || this.bookId || '');

                const response = await fetch('/api/pronunciation/assess', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        this.pronunciationResult = data;
                        this.pronunciationFeedback = '';

                        // È¢ÑÂä†ËΩΩÁªÉ‰π†ÂçïËØçÈü≥È¢ëÔºà‰∏çÈòªÂ°û UIÔºâ
                        this.preloadPracticeWordAudios(data.practice_words);
                    } else {
                        // ÊòæÁ§∫ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ
                        const errorMsg = data.error || 'ËØÑ‰º∞Â§±Ë¥•';
                        console.error('[ÂΩïÈü≥] ÊúçÂä°Á´ØÈîôËØØ:', errorMsg);
                        this.pronunciationFeedback = `${errorMsg}ÔºåËØ∑ÈáçËØï`;
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    const detail = errorData.detail || errorData.error || `HTTP ${response.status}`;
                    console.error('[ÂΩïÈü≥] ËØ∑Ê±ÇÂ§±Ë¥•:', detail);
                    this.pronunciationFeedback = `${detail}ÔºåËØ∑ÈáçËØï`;
                }
            } catch (e) {
                console.error('Êèê‰∫§ËØÑ‰º∞Â§±Ë¥•:', e);
                this.pronunciationFeedback = 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï';
            } finally {
                this.pronunciationSubmitting = false;
            }
        },

        async replayPronunciationDemo() {
            await this.playAudioAndWait('normal');
        },

        // È¢ÑÂä†ËΩΩÁªÉ‰π†ÂçïËØçÈü≥È¢ëÔºàÂú®ÊòæÁ§∫ÁªìÊûúÊó∂Ë∞ÉÁî®Ôºå‰∏çÈòªÂ°û UIÔºâ
        preloadPracticeWordAudios(practiceWords) {
            if (!practiceWords || practiceWords.length === 0) return;

            practiceWords.forEach(pw => {
                const word = pw.word || pw;
                if (!word || this.practiceWordAudioCache[word]) return;

                const url = `/api/tts/normal/${encodeURIComponent(word)}`;
                // ‰ΩøÁî® Howl È¢ÑÂä†ËΩΩ‰ΩÜ‰∏çÊí≠Êîæ
                this.practiceWordAudioCache[word] = new Howl({
                    src: [url],
                    format: ['mp3'],
                    preload: true,
                    onloaderror: (id, err) => {
                        console.error(`È¢ÑÂä†ËΩΩ ${word} Èü≥È¢ëÂ§±Ë¥•:`, err);
                        delete this.practiceWordAudioCache[word];
                    }
                });
            });
        },

        async playPracticeWord(word) {
            // Êí≠ÊîæÊé®ËçêÁªÉ‰π†ÂçïËØçÁöÑÂèëÈü≥
            if (this.audioPlaying) return;

            this.audioPlaying = true;

            // ‰ºòÂÖà‰ΩøÁî®È¢ÑÂä†ËΩΩÁºìÂ≠òÁöÑÈü≥È¢ë
            const cachedHowl = this.practiceWordAudioCache[word];
            if (cachedHowl && cachedHowl.state() === 'loaded') {
                TTS.stop();  // ÂÅúÊ≠¢Áªü‰∏Ä TTS Êí≠ÊîæÂô®
                cachedHowl.off('end');
                cachedHowl.on('end', () => {
                    this.audioPlaying = false;
                });
                cachedHowl.play();
            } else {
                // ÁºìÂ≠òÊú™ÂëΩ‰∏≠Ôºå‰ΩøÁî®Áªü‰∏Ä TTS Ê®°Âùó
                try {
                    await TTS.playWord(word, 'normal');
                } catch (e) {
                    console.error('ÁªÉ‰π†ÂçïËØçÈü≥È¢ëÂä†ËΩΩÂ§±Ë¥•:', e);
                } finally {
                    this.audioPlaying = false;
                }
            }
        },

        skipPronunciation() {
            this.showPronunciationUI = false;
            this.nextWord();
        },

        async retryPronunciation() {
            this.pronunciationResult = null;
            this.pronunciationFeedback = 'ËØ∑ÂÜçÊ¨°Ë∑üËØª';
            // ÂÖàÊí≠Êîæ‰∏ÄÊ¨°Ê†áÂáÜÂèëÈü≥
            await this.playAudioAndWait('normal');
        },

        continuePronunciation() {
            this.showPronunciationUI = false;
            this.nextWord();
        },

        // ========== Âº∫ÂåñÂ≠¶‰π†Áõ∏ÂÖ≥ÊñπÊ≥ï ==========

        // Èü≥ËäÇÈ¢úËâ≤Ôºà‰∫§Êõø‰ΩøÁî®Ôºâ
        SYLLABLE_COLORS: ['text-sky-400', 'text-amber-400', 'text-emerald-400', 'text-rose-400', 'text-purple-400'],

        async startReinforcementLearning() {
            // ËøõÂÖ•Âº∫ÂåñÂ≠¶‰π†Ê®°Âºè
            this.reinforceMode = true;
            this.reinforceCount = 0;
            this.reinforceSyllables = [];
            this.reinforceSyllablesHtml = '';

            // Ëé∑ÂèñÈü≥ËäÇÂàÜËß£
            try {
                const resp = await fetch(`/api/tts/syllables/${encodeURIComponent(this.currentCard.word)}`);
                if (resp.ok) {
                    const data = await resp.json();
                    this.reinforceSyllables = data.syllables || [];
                    // ÁîüÊàêÂΩ©Ëâ≤Èü≥ËäÇ HTML
                    let colorIdx = 0;
                    this.reinforceSyllablesHtml = this.reinforceSyllables.map((syl) => {
                        if (syl === ' ') {
                            return '<span class="inline-block w-4"></span>';
                        }
                        const color = this.SYLLABLE_COLORS[colorIdx % this.SYLLABLE_COLORS.length];
                        colorIdx++;
                        return `<span class="${color}">${syl}</span>`;
                    }).join('');
                } else {
                    this.reinforceSyllablesHtml = `<span class="text-sky-400">${this.currentCard.word}</span>`;
                }
            } catch (e) {
                console.error('Ëé∑ÂèñÈü≥ËäÇÂ§±Ë¥•:', e);
                this.reinforceSyllablesHtml = `<span class="text-sky-400">${this.currentCard.word}</span>`;
            }

            // ÈáçÁΩÆËæìÂÖ•Áä∂ÊÄÅÔºåÂêØÁî®ËæìÂÖ•Ê°Ü
            this.userInput = '';
            this.inputDisabled = false;
            this.showResult = false;
            this.showAnswer = false;
            this.hint = '';
            this.attempt = 0;

            // Êí≠ÊîæÂçïËØçÂèëÈü≥
            await this.playAudioAndWait('normal');

            // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
            this.$nextTick(() => {
                this.$refs.inputField?.focus();
            });
        },

        async submitReinforceAnswer() {
            // Âº∫ÂåñÂ≠¶‰π†Ê®°Âºè‰∏ãÁöÑÁ≠îÊ°àÊèê‰∫§
            const input = this.userInput.trim();
            if (!input) return;

            const isCorrect = input.toLowerCase() === this.currentCard.word.toLowerCase();

            if (isCorrect) {
                this.reinforceCount++;

                if (this.reinforceCount >= 2) {
                    // ÂÆåÊàêÂº∫ÂåñÂ≠¶‰π†
                    this.reinforceMode = false;
                    this.nextWord();
                } else {
                    // ÁªßÁª≠‰∏ã‰∏ÄËΩÆ
                    this.userInput = '';
                    this.hint = `Ê≠£Á°ÆÔºÅÂÜçÊù•‰∏ÄÊ¨° (${this.reinforceCount}/2)`;
                    await this.playAudioAndWait('normal');
                    this.$nextTick(() => {
                        this.$refs.inputField?.focus();
                    });
                }
            } else {
                // ÈîôËØØÔºåÈáçËØï
                this.userInput = '';
                this.hint = 'ÂÜçËØï‰∏ÄÊ¨°';
                TTS.playWord(this.currentCard.word);
                this.$nextTick(() => {
                    this.$refs.inputField?.focus();
                });
            }
        },

        // ========== ÁªìÊùüË∑üËØªÁõ∏ÂÖ≥ÊñπÊ≥ï ==========

        startConversationPractice() {
            // Â∞ÜÂ∑≤Â≠¶ÂçïËØçÂ≠òÂÖ• sessionStorageÔºàÂ∏¶ÈîôËØØ‰øùÊä§Ôºâ
            const learnedWords = this.cards.map(card => ({
                word: card.word,
                translation: card.translation
            }));

            // Ê†πÊçÆÂçïËØçÊï∞ÈáèËÆ°ÁÆóÂØπËØùËΩÆÊï∞
            const wordCount = learnedWords.length;
            let rounds = 5;
            if (wordCount < 10) rounds = 3;
            else if (wordCount < 20) rounds = 5;
            else if (wordCount < 40) rounds = 7;
            else rounds = 10;

            try {
                sessionStorage.setItem('learnedWords', JSON.stringify(learnedWords));
                sessionStorage.setItem('conversationRounds', rounds);
            } catch (e) {
                console.error('‰øùÂ≠ò sessionStorage Â§±Ë¥•:', e);
            }

            // Ë∑≥ËΩ¨Âà∞ÂØπËØùÁªÉ‰π†È°µÈù¢Ôºà‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÂçïËØçÁöÑËØç‰π¶ÊàñÈªòËÆ§ËØç‰π¶Ôºâ
            const targetBookId = this.cards[0]?.book_id || this.bookId;
            if (targetBookId) {
                window.location.href = `/conversation/${targetBookId}`;
            } else {
                // ÂÖ®Â±ÄÂ§ç‰π†Ê≤°ÊúâÂõ∫ÂÆöËØç‰π¶ÔºåËøîÂõûÈ¶ñÈ°µ
                window.location.href = '/';
            }
        }
    }
}
</script>
{% endblock %}
