{% extends "base.html" %}

{% block title %}è·Ÿè¯»ç»ƒä¹  - è‹±è¯­å­¦ä¹ {% endblock %}

{% block head %}
<script src="/static/recorder.js"></script>
{% endblock %}

{% block body %}
<div class="min-h-screen bg-slate-900 flex flex-col" x-data="readingPage()">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-slate-800/80 backdrop-blur-sm shadow-lg border-b border-slate-700/50">
        <div class="max-w-2xl mx-auto px-4 py-3 flex items-center justify-between">
            <button @click="goBack" class="text-slate-400 hover:text-slate-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div class="text-center">
                <span class="font-medium text-slate-100">è·Ÿè¯»ç»ƒä¹ </span>
                <div class="text-xs text-slate-400" x-text="bookName"></div>
            </div>
            <!-- éŸ³è‰²é€‰æ‹© -->
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="text-slate-400 hover:text-slate-200 flex items-center gap-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 5.586v12.828a1 1 0 01-1.707.707L5.586 15z"/>
                    </svg>
                </button>
                <div x-show="open" @click.away="open = false" x-cloak
                     class="absolute right-0 mt-2 w-32 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 py-1">
                    <template x-for="v in TTS.voices" :key="v.id">
                        <button @click="TTS.setVoice(v.id); open = false"
                                :class="TTS.getVoice() === v.id ? 'text-sky-400 bg-slate-700/50' : 'text-slate-300 hover:bg-slate-700/30'"
                                class="w-full text-left px-3 py-1.5 text-sm"
                                x-text="v.label"></button>
                    </template>
                </div>
            </div>
        </div>
    </header>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div x-show="isLoading && !passage" class="flex-1 flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mx-auto mb-4"></div>
            <p class="text-slate-400" x-text="loadingText"></p>
        </div>
    </div>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <div x-show="error" class="flex-1 flex items-center justify-center p-4">
        <div class="text-center max-w-sm">
            <div class="text-4xl mb-4">ğŸ˜”</div>
            <p class="text-slate-300 mb-4" x-text="error"></p>
            <button @click="goBack" class="px-6 py-2 bg-slate-700 text-slate-200 rounded-lg">
                è¿”å›
            </button>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <main x-show="!error && passage" x-cloak class="flex-1 flex flex-col max-w-2xl mx-auto w-full p-4">

        <!-- é€‰æ‹©æ¨¡å¼ç•Œé¢ -->
        <div x-show="phase === 'select'" class="flex-1 flex flex-col">
            <!-- çŸ­æ–‡æ˜¾ç¤º -->
            <div class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4">
                <div class="text-slate-100 text-lg leading-relaxed whitespace-pre-wrap" x-text="passage"></div>
            </div>

            <!-- ä½¿ç”¨çš„å•è¯ -->
            <div x-show="wordsUsed.length > 0" class="mb-4">
                <div class="text-slate-400 text-sm mb-2">åŒ…å«å•è¯ï¼š</div>
                <div class="flex flex-wrap gap-2">
                    <template x-for="word in wordsUsed" :key="word">
                        <span class="px-3 py-1 bg-emerald-500/20 text-emerald-300 rounded-full text-sm" x-text="word"></span>
                    </template>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex gap-3 mb-6">
                <button
                    @click="playFullPassage"
                    :disabled="isPlaying"
                    class="flex-1 py-3 bg-slate-700 text-slate-200 rounded-xl hover:bg-slate-600 transition flex items-center justify-center gap-2 disabled:opacity-50"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                    </svg>
                    <span x-text="isPlaying ? 'æ’­æ”¾ä¸­...' : 'æ’­æ”¾å…¨æ–‡'"></span>
                </button>
                <button
                    @click="regeneratePassage"
                    :disabled="isLoading"
                    class="py-3 px-4 bg-slate-700 text-slate-200 rounded-xl hover:bg-slate-600 transition disabled:opacity-50"
                    title="æ¢ä¸€ç¯‡"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </button>
            </div>

            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="text-slate-400 text-sm mb-3">é€‰æ‹©ç»ƒä¹ æ¨¡å¼ï¼š</div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button
                    @click="startSentenceMode"
                    class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-4 rounded-xl font-medium hover:from-emerald-600 hover:to-teal-600 transition shadow-lg shadow-teal-500/20"
                >
                    <div class="text-lg">é€å¥æœ—è¯»</div>
                    <div class="text-sm opacity-80">æ¨èåˆå­¦è€…</div>
                </button>
                <button
                    @click="startFullMode"
                    class="bg-gradient-to-r from-sky-500 to-blue-500 text-white py-4 rounded-xl font-medium hover:from-sky-600 hover:to-blue-600 transition shadow-lg shadow-blue-500/20"
                >
                    <div class="text-lg">æ•´ç¯‡æœ—è¯»</div>
                    <div class="text-sm opacity-80">ç»ƒä¹ è¿è´¯æ€§</div>
                </button>
            </div>

            <!-- ç¿»è¯‘ç»ƒä¹ å…¥å£ -->
            <button
                @click="startTranslateMode"
                class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-xl font-medium hover:from-amber-600 hover:to-orange-600 transition shadow-lg shadow-orange-500/20"
            >
                <div class="text-lg flex items-center justify-center gap-2">
                    <span>çŸ­æ–‡ç¿»è¯‘ç»ƒä¹ </span>
                </div>
                <div class="text-sm opacity-80">å°†æ•´ç¯‡çŸ­æ–‡ç¿»è¯‘æˆä¸­æ–‡</div>
            </button>
        </div>

        <!-- é€å¥æ¨¡å¼ç•Œé¢ -->
        <div x-show="phase === 'sentence'" class="flex-1 flex flex-col">
            <!-- è¿›åº¦ -->
            <div class="text-center text-slate-400 text-sm mb-4">
                ç¬¬ <span x-text="currentSentenceIndex + 1"></span> / <span x-text="sentences.length"></span> å¥
            </div>

            <!-- çŸ­æ–‡æ˜¾ç¤ºï¼ˆé«˜äº®å½“å‰å¥ï¼‰ -->
            <div class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4">
                <template x-for="(sentence, idx) in sentences" :key="idx">
                    <span
                        :class="{
                            'text-emerald-400 font-medium': idx === currentSentenceIndex,
                            'text-slate-500': idx < currentSentenceIndex,
                            'text-slate-300': idx > currentSentenceIndex
                        }"
                        class="text-lg leading-relaxed"
                        x-text="sentence + ' '"
                    ></span>
                </template>
            </div>

            <!-- å½“å‰å¥è¯„åˆ†ï¼ˆå¦‚æœå·²è¯„ä¼°ï¼‰ -->
            <div x-show="sentenceResults[currentSentenceIndex]" class="bg-slate-800/30 rounded-xl p-4 mb-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-slate-400">å‘éŸ³å¾—åˆ†</span>
                    <span
                        :class="{
                            'text-emerald-400': sentenceResults[currentSentenceIndex]?.accuracy >= 80,
                            'text-amber-400': sentenceResults[currentSentenceIndex]?.accuracy >= 60 && sentenceResults[currentSentenceIndex]?.accuracy < 80,
                            'text-rose-400': sentenceResults[currentSentenceIndex]?.accuracy < 60
                        }"
                        class="text-xl font-bold"
                        x-text="(sentenceResults[currentSentenceIndex]?.accuracy || 0) + '%'"
                    ></span>
                </div>
                <!-- æ¼è¯»å•è¯ -->
                <div x-show="sentenceResults[currentSentenceIndex]?.omittedWords?.length > 0" class="mb-1">
                    <span class="text-rose-400 text-sm">æ¼è¯»ï¼š</span>
                    <template x-for="word in sentenceResults[currentSentenceIndex]?.omittedWords" :key="word">
                        <span class="text-rose-300 text-sm ml-2 bg-rose-500/20 px-2 py-0.5 rounded" x-text="word"></span>
                    </template>
                </div>
                <!-- è¯»é”™å•è¯ -->
                <div x-show="sentenceResults[currentSentenceIndex]?.mispronouncedWords?.length > 0" class="mb-1">
                    <span class="text-amber-400 text-sm">è¯»é”™ï¼š</span>
                    <template x-for="pw in sentenceResults[currentSentenceIndex]?.mispronouncedWords" :key="pw.word">
                        <span class="text-amber-300 text-sm ml-2 bg-amber-500/20 px-2 py-0.5 rounded" x-text="pw.word + ' (' + pw.accuracy + '%)'"></span>
                    </template>
                </div>
                <!-- éœ€æ³¨æ„å•è¯ -->
                <div x-show="sentenceResults[currentSentenceIndex]?.problemWords?.length > 0">
                    <span class="text-slate-500 text-sm">éœ€æ³¨æ„ï¼š</span>
                    <template x-for="pw in sentenceResults[currentSentenceIndex]?.problemWords" :key="pw.word">
                        <span class="text-slate-400 text-sm ml-2" x-text="pw.word + ' (' + pw.accuracy + '%)'"></span>
                    </template>
                </div>
            </div>

            <!-- æ’­æ”¾å½“å‰å¥ -->
            <button
                @click="playCurrentSentence"
                :disabled="isPlaying"
                class="w-full py-3 bg-slate-700 text-slate-200 rounded-xl hover:bg-slate-600 transition flex items-center justify-center gap-2 mb-4 disabled:opacity-50"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                </svg>
                <span x-text="isPlaying ? 'æ’­æ”¾ä¸­...' : 'æ’­æ”¾å½“å‰å¥'"></span>
            </button>

            <!-- å½•éŸ³æŒ‰é’® -->
            <div class="flex flex-col items-center py-4">
                <button
                    @mousedown="startRecording"
                    @mouseup="stopRecording"
                    @mouseleave="isRecording && stopRecording()"
                    @touchstart.prevent="startRecording"
                    @touchend.prevent="stopRecording"
                    :disabled="isAssessing || !recorderReady"
                    :class="isRecording
                        ? 'bg-rose-500 scale-110 shadow-lg shadow-rose-500/50'
                        : 'bg-emerald-600 hover:bg-emerald-500'"
                    class="w-20 h-20 rounded-full flex items-center justify-center transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg x-show="!isRecording" class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                    <div x-show="isRecording" class="w-6 h-6 bg-white rounded-sm"></div>
                </button>
                <p class="text-slate-400 text-sm mt-3">
                    <span x-show="!recorderReady">æ­£åœ¨åˆå§‹åŒ–éº¦å…‹é£...</span>
                    <span x-show="recorderReady && !isRecording && !isAssessing">æŒ‰ä½å½•éŸ³</span>
                    <span x-show="isRecording">æ¾å¼€ç»“æŸå½•éŸ³</span>
                    <span x-show="isAssessing">è¯„ä¼°ä¸­...</span>
                </p>

                <!-- å½•éŸ³æ—¶é•¿ -->
                <div x-show="isRecording" class="mt-2 text-rose-400 text-sm font-mono" x-text="recordingDuration"></div>
            </div>

            <!-- ä¸‹ä¸€å¥/æŸ¥çœ‹ç»“æœæŒ‰é’® -->
            <div class="mt-auto flex gap-3">
                <button
                    x-show="currentSentenceIndex < sentences.length - 1"
                    @click="nextSentence"
                    :disabled="!sentenceResults[currentSentenceIndex]"
                    class="flex-1 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-medium hover:from-emerald-600 hover:to-teal-600 transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    ä¸‹ä¸€å¥
                </button>
                <button
                    x-show="currentSentenceIndex === sentences.length - 1 && sentenceResults[currentSentenceIndex]"
                    @click="showResults"
                    class="flex-1 py-3 bg-gradient-to-r from-violet-500 to-purple-500 text-white rounded-xl font-medium hover:from-violet-600 hover:to-purple-600 transition"
                >
                    æŸ¥çœ‹è¯„ä»·
                </button>
            </div>
        </div>

        <!-- æ•´ç¯‡æ¨¡å¼ç•Œé¢ -->
        <div x-show="phase === 'full'" class="flex-1 flex flex-col">
            <!-- çŸ­æ–‡æ˜¾ç¤º -->
            <div class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4">
                <div class="text-slate-100 text-lg leading-relaxed whitespace-pre-wrap" x-text="passage"></div>
            </div>

            <!-- æ’­æ”¾å…¨æ–‡ -->
            <button
                @click="playFullPassage"
                :disabled="isPlaying"
                class="w-full py-3 bg-slate-700 text-slate-200 rounded-xl hover:bg-slate-600 transition flex items-center justify-center gap-2 mb-4 disabled:opacity-50"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                </svg>
                <span x-text="isPlaying ? 'æ’­æ”¾ä¸­...' : 'æ’­æ”¾å…¨æ–‡'"></span>
            </button>

            <!-- å½•éŸ³æŒ‰é’® -->
            <div class="flex flex-col items-center py-4">
                <button
                    @mousedown="startRecording"
                    @mouseup="stopRecording"
                    @mouseleave="isRecording && stopRecording()"
                    @touchstart.prevent="startRecording"
                    @touchend.prevent="stopRecording"
                    :disabled="isAssessing || !recorderReady"
                    :class="isRecording
                        ? 'bg-rose-500 scale-110 shadow-lg shadow-rose-500/50'
                        : 'bg-sky-600 hover:bg-sky-500'"
                    class="w-20 h-20 rounded-full flex items-center justify-center transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg x-show="!isRecording" class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                    <div x-show="isRecording" class="w-6 h-6 bg-white rounded-sm"></div>
                </button>
                <p class="text-slate-400 text-sm mt-3">
                    <span x-show="!recorderReady">æ­£åœ¨åˆå§‹åŒ–éº¦å…‹é£...</span>
                    <span x-show="recorderReady && !isRecording && !isAssessing">æŒ‰ä½å½•éŸ³ï¼Œä¸€æ¬¡è¯»å®Œæ•´ç¯‡</span>
                    <span x-show="isRecording">æ¾å¼€ç»“æŸå½•éŸ³</span>
                    <span x-show="isAssessing">è¯„ä¼°ä¸­...</span>
                </p>

                <!-- å½•éŸ³æ—¶é•¿ -->
                <div x-show="isRecording" class="mt-2 text-rose-400 text-sm font-mono" x-text="recordingDuration"></div>
            </div>
        </div>

        <!-- è¯„ä¼°ç»“æœç•Œé¢ -->
        <div x-show="phase === 'result'" class="flex-1 flex flex-col overflow-y-auto">
            <!-- æ€»ä½“å¾—åˆ† -->
            <div class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4 text-center">
                <div class="text-slate-400 text-sm mb-2">æ€»ä½“å¾—åˆ†</div>
                <div
                    :class="{
                        'text-emerald-400': overallScore >= 80,
                        'text-amber-400': overallScore >= 60 && overallScore < 80,
                        'text-rose-400': overallScore < 60
                    }"
                    class="text-5xl font-bold mb-2"
                    x-text="overallScore + '%'"
                ></div>
            </div>

            <!-- å„å¥å¾—åˆ† -->
            <div class="bg-slate-800/30 rounded-xl p-4 mb-4">
                <div class="text-slate-400 text-sm mb-3">å„å¥å¾—åˆ†</div>
                <template x-for="(result, idx) in sentenceResults" :key="idx">
                    <div class="flex items-center justify-between py-2 border-b border-slate-700/50 last:border-b-0">
                        <span class="text-slate-300 text-sm truncate flex-1 mr-4" x-text="'å¥' + (idx + 1) + ': ' + sentences[idx].substring(0, 30) + (sentences[idx].length > 30 ? '...' : '')"></span>
                        <div class="flex items-center gap-2">
                            <div class="w-24 bg-slate-700/50 rounded-full h-2">
                                <div
                                    :class="{
                                        'bg-emerald-500': result?.accuracy >= 80,
                                        'bg-amber-500': result?.accuracy >= 60 && result?.accuracy < 80,
                                        'bg-rose-500': result?.accuracy < 60
                                    }"
                                    class="h-full rounded-full transition-all"
                                    :style="'width: ' + (result?.accuracy || 0) + '%'"
                                ></div>
                            </div>
                            <span
                                :class="{
                                    'text-emerald-400': result?.accuracy >= 80,
                                    'text-amber-400': result?.accuracy >= 60 && result?.accuracy < 80,
                                    'text-rose-400': result?.accuracy < 60
                                }"
                                class="text-sm font-medium w-12 text-right"
                                x-text="(result?.accuracy || 0) + '%'"
                            ></span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- é”™è¯¯å•è¯æ±‡æ€» -->
            <div x-show="getAllOmittedWords().length > 0 || getAllMispronouncedWords().length > 0" class="bg-slate-800/30 rounded-xl p-4 mb-4">
                <!-- æ¼è¯»å•è¯ -->
                <div x-show="getAllOmittedWords().length > 0" class="mb-3">
                    <div class="text-rose-400 text-sm mb-2">æ¼è¯»çš„å•è¯ï¼š</div>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="word in getAllOmittedWords()" :key="word">
                            <span class="text-rose-300 text-sm bg-rose-500/20 px-3 py-1 rounded-full" x-text="word"></span>
                        </template>
                    </div>
                </div>
                <!-- è¯»é”™å•è¯ -->
                <div x-show="getAllMispronouncedWords().length > 0">
                    <div class="text-amber-400 text-sm mb-2">è¯»é”™çš„å•è¯ï¼š</div>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="pw in getAllMispronouncedWords()" :key="pw.word">
                            <span class="text-amber-300 text-sm bg-amber-500/20 px-3 py-1 rounded-full" x-text="pw.word + ' (' + pw.accuracy + '%)'"></span>
                        </template>
                    </div>
                </div>
            </div>

            <!-- é—®é¢˜å’Œå»ºè®® -->
            <div x-show="feedback?.problems?.length > 0 || feedback?.suggestions?.length > 0" class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4">
                <!-- é—®é¢˜ -->
                <div x-show="feedback?.problems?.length > 0" class="mb-3">
                    <div class="text-amber-400 text-sm mb-2">ä¸»è¦é—®é¢˜ï¼š</div>
                    <ul class="text-slate-300 text-sm space-y-1">
                        <template x-for="problem in (feedback?.problems || [])" :key="problem">
                            <li class="flex items-start gap-2">
                                <span class="text-amber-500">â€¢</span>
                                <span x-text="problem"></span>
                            </li>
                        </template>
                    </ul>
                </div>

                <!-- å»ºè®® -->
                <div x-show="feedback?.suggestions?.length > 0">
                    <div class="text-emerald-400 text-sm mb-2">æ”¹è¿›å»ºè®®ï¼š</div>
                    <ul class="text-slate-300 text-sm space-y-1">
                        <template x-for="suggestion in (feedback?.suggestions || [])" :key="suggestion">
                            <li class="flex items-start gap-2">
                                <span class="text-emerald-500">â€¢</span>
                                <span x-text="suggestion"></span>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>

            <!-- ä¸“é¡¹ç»ƒä¹ æç¤º -->
            <div x-show="(getAllOmittedWords().length > 0 || getAllMispronouncedWords().length > 0) && !showWordPractice" class="bg-gradient-to-r from-violet-500/20 to-purple-500/20 rounded-xl p-4 mb-4 border border-violet-500/30">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-violet-300 font-medium mb-1">éœ€è¦é’ˆå¯¹é”™è¯¯å•è¯ç»ƒä¹ å—ï¼Ÿ</div>
                        <div class="text-slate-400 text-sm">å¯ä»¥é€ä¸ªç»ƒä¹ è¯»é”™æˆ–æ¼è¯»çš„å•è¯</div>
                    </div>
                    <button
                        @click="startWordPractice"
                        class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition text-sm font-medium"
                    >
                        å¼€å§‹ç»ƒä¹ 
                    </button>
                </div>
            </div>

            <!-- å•è¯ä¸“é¡¹ç»ƒä¹ ç•Œé¢ -->
            <div x-show="showWordPractice" class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-violet-400 font-medium">å•è¯ä¸“é¡¹ç»ƒä¹ </div>
                    <div class="text-slate-400 text-sm">
                        <span x-text="currentPracticeIndex + 1"></span> / <span x-text="practiceWords.length"></span>
                    </div>
                </div>

                <!-- å½“å‰ç»ƒä¹ å•è¯ -->
                <div class="text-center py-6">
                    <div class="text-3xl font-bold text-slate-100 mb-2" x-text="practiceWords[currentPracticeIndex]?.word || ''"></div>
                    <button
                        @click="playPracticeWord"
                        :disabled="isPlaying"
                        class="text-slate-400 hover:text-slate-200 transition"
                    >
                        <svg class="w-6 h-6 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                        </svg>
                        <span class="text-sm ml-1">æ’­æ”¾å‘éŸ³</span>
                    </button>
                </div>

                <!-- å½•éŸ³æŒ‰é’® -->
                <div class="flex flex-col items-center py-4">
                    <button
                        @mousedown="startPracticeRecording"
                        @mouseup="stopPracticeRecording"
                        @mouseleave="isPracticeRecording && stopPracticeRecording()"
                        @touchstart.prevent="startPracticeRecording"
                        @touchend.prevent="stopPracticeRecording"
                        :disabled="isPracticeAssessing || !recorderReady"
                        :class="isPracticeRecording
                            ? 'bg-rose-500 scale-110 shadow-lg shadow-rose-500/50'
                            : 'bg-violet-600 hover:bg-violet-500'"
                        class="w-16 h-16 rounded-full flex items-center justify-center transition-all duration-200 disabled:opacity-50"
                    >
                        <svg x-show="!isPracticeRecording" class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                        <div x-show="isPracticeRecording" class="w-5 h-5 bg-white rounded-sm"></div>
                    </button>
                    <p class="text-slate-400 text-xs mt-2">
                        <span x-show="!isPracticeRecording && !isPracticeAssessing">æŒ‰ä½å½•éŸ³</span>
                        <span x-show="isPracticeRecording">æ¾å¼€ç»“æŸ</span>
                        <span x-show="isPracticeAssessing">è¯„ä¼°ä¸­...</span>
                    </p>
                </div>

                <!-- å•è¯ç»ƒä¹ ç»“æœ -->
                <div x-show="practiceResult" class="text-center py-2">
                    <span
                        :class="{
                            'text-emerald-400': practiceResult?.accuracy >= 80,
                            'text-amber-400': practiceResult?.accuracy >= 60 && practiceResult?.accuracy < 80,
                            'text-rose-400': practiceResult?.accuracy < 60
                        }"
                        class="text-2xl font-bold"
                        x-text="(practiceResult?.accuracy || 0) + '%'"
                    ></span>
                </div>

                <!-- å¯¼èˆªæŒ‰é’® -->
                <div class="flex gap-3 mt-4">
                    <button
                        @click="prevPracticeWord"
                        :disabled="currentPracticeIndex === 0"
                        class="flex-1 py-2 bg-slate-700 text-slate-200 rounded-lg hover:bg-slate-600 transition disabled:opacity-50 text-sm"
                    >
                        ä¸Šä¸€ä¸ª
                    </button>
                    <button
                        x-show="currentPracticeIndex < practiceWords.length - 1"
                        @click="nextPracticeWord"
                        class="flex-1 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 transition text-sm"
                    >
                        ä¸‹ä¸€ä¸ª
                    </button>
                    <button
                        x-show="currentPracticeIndex === practiceWords.length - 1"
                        @click="endWordPractice"
                        class="flex-1 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition text-sm"
                    >
                        å®Œæˆç»ƒä¹ 
                    </button>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="mt-auto flex gap-3">
                <button
                    @click="restart"
                    class="flex-1 py-3 bg-slate-700 text-slate-200 rounded-xl hover:bg-slate-600 transition"
                >
                    é‡æ–°ç»ƒä¹ 
                </button>
                <button
                    @click="goBack"
                    class="flex-1 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-medium hover:from-emerald-600 hover:to-teal-600 transition"
                >
                    è¿”å›é¦–é¡µ
                </button>
            </div>
        </div>

        <!-- ç¿»è¯‘ç»ƒä¹ ç•Œé¢ -->
        <div x-show="phase === 'translate'" class="flex-1 flex flex-col">
            <!-- æ ‡é¢˜ -->
            <div class="text-center text-slate-400 text-sm mb-4">
                è¯·å°†ä¸‹é¢çš„è‹±æ–‡çŸ­æ–‡ç¿»è¯‘æˆä¸­æ–‡
            </div>

            <!-- è‹±æ–‡çŸ­æ–‡æ˜¾ç¤º -->
            <div class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-amber-400 text-sm font-medium">è‹±æ–‡åŸæ–‡</span>
                    <!-- æ’­æ”¾çŸ­æ–‡æœ—è¯» -->
                    <button
                        @click="playPassageAudio"
                        :disabled="isPlaying"
                        class="px-3 py-1 bg-slate-700 text-slate-200 rounded-lg hover:bg-slate-600 transition flex items-center gap-1 text-sm disabled:opacity-50"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                        </svg>
                        <span x-text="isPlaying ? 'æ’­æ”¾ä¸­' : 'æœ—è¯»'"></span>
                    </button>
                </div>
                <p class="text-slate-100 text-lg leading-relaxed" x-text="passage"></p>
            </div>

            <!-- å½•éŸ³æŒ‰é’® -->
            <div class="flex flex-col items-center py-4" x-show="!translateResult">
                <div class="text-slate-400 text-sm mb-3">æŒ‰ä½æŒ‰é’®ï¼Œç”¨ä¸­æ–‡è¯´å‡ºç¿»è¯‘</div>
                <button
                    @mousedown="startTranslateRecording"
                    @mouseup="stopTranslateRecording"
                    @mouseleave="isTranslateRecording && stopTranslateRecording()"
                    @touchstart.prevent="startTranslateRecording"
                    @touchend.prevent="stopTranslateRecording"
                    :disabled="isTranslateAssessing || !recorderReady"
                    :class="isTranslateRecording
                        ? 'bg-rose-500 scale-110 shadow-lg shadow-rose-500/50'
                        : 'bg-amber-500 hover:bg-amber-400'"
                    class="w-24 h-24 rounded-full flex items-center justify-center transition-all duration-200 disabled:opacity-50"
                >
                    <svg x-show="!isTranslateRecording" class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                    <div x-show="isTranslateRecording" class="w-8 h-8 bg-white rounded-sm"></div>
                </button>
                <div class="text-slate-500 text-sm mt-3" x-text="isTranslateRecording ? 'æ¾å¼€ç»“æŸå½•éŸ³' : 'æŒ‰ä½è¯´è¯'"></div>
            </div>

            <!-- è¯„ä¼°ä¸­çŠ¶æ€ -->
            <div x-show="isTranslateAssessing && !translateResult" class="text-center py-8">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-amber-500 mx-auto mb-3"></div>
                <div class="text-slate-400">æ­£åœ¨è¯„ä¼°ç¿»è¯‘...</div>
            </div>

            <!-- ç¿»è¯‘ç»“æœ -->
            <div x-show="translateResult" class="bg-slate-800/50 backdrop-blur rounded-xl p-5 border border-slate-700/50 overflow-y-auto max-h-[60vh]">
                <!-- ä½ çš„ç¿»è¯‘ -->
                <div class="mb-4 pb-4 border-b border-slate-700/50">
                    <div class="text-slate-400 text-sm mb-2">ä½ çš„ç¿»è¯‘:</div>
                    <p class="text-slate-100 leading-relaxed" x-text="translateResult?.recognized_text || '(æœªè¯†åˆ«)'"></p>
                </div>

                <!-- AI å‚è€ƒç¿»è¯‘ -->
                <div class="mb-4 pb-4 border-b border-slate-700/50">
                    <div class="text-slate-400 text-sm mb-2">å‚è€ƒç¿»è¯‘:</div>
                    <p class="text-amber-400 leading-relaxed" x-text="translateResult?.reference_text"></p>
                </div>

                <!-- è¯„åˆ†å’Œè¯„ä»· -->
                <div class="mb-4">
                    <!-- å¾—åˆ† -->
                    <div class="flex items-center justify-center gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold" :class="translateResult?.score >= 80 ? 'text-emerald-400' : translateResult?.score >= 60 ? 'text-amber-400' : 'text-rose-400'" x-text="translateResult?.score || 0"></div>
                            <div class="text-slate-500 text-sm">ç¿»è¯‘å¾—åˆ†</div>
                        </div>
                    </div>

                    <!-- AI è¯„ä»· -->
                    <div class="bg-slate-700/50 rounded-lg p-4">
                        <div class="text-slate-300 mb-2" x-text="translateResult?.feedback"></div>

                        <!-- ä¼˜ç‚¹ -->
                        <template x-if="translateResult?.strengths && translateResult.strengths.length > 0">
                            <div class="mt-3">
                                <div class="text-emerald-400 text-sm mb-1">ä¼˜ç‚¹ï¼š</div>
                                <ul class="text-slate-400 text-sm list-disc list-inside">
                                    <template x-for="item in translateResult.strengths" :key="item">
                                        <li x-text="item"></li>
                                    </template>
                                </ul>
                            </div>
                        </template>

                        <!-- éœ€è¦æ”¹è¿› -->
                        <template x-if="translateResult?.issues && translateResult.issues.length > 0">
                            <div class="mt-3">
                                <div class="text-amber-400 text-sm mb-1">éœ€è¦æ”¹è¿›ï¼š</div>
                                <ul class="text-slate-400 text-sm list-disc list-inside">
                                    <template x-for="item in translateResult.issues" :key="item">
                                        <li x-text="item"></li>
                                    </template>
                                </ul>
                            </div>
                        </template>

                        <!-- å»ºè®® -->
                        <div x-show="translateResult?.suggestion" class="mt-3 text-slate-400 text-sm">
                            <span class="text-sky-400">å»ºè®®ï¼š</span>
                            <span x-text="translateResult?.suggestion"></span>
                        </div>
                    </div>
                </div>

                <!-- é‡è¯•/å®ŒæˆæŒ‰é’® -->
                <div class="flex gap-3">
                    <button
                        @click="retryTranslate"
                        class="flex-1 py-3 bg-slate-700 text-slate-200 rounded-xl hover:bg-slate-600 transition"
                    >
                        é‡æ–°ç¿»è¯‘
                    </button>
                    <button
                        @click="finishTranslate"
                        class="flex-1 py-3 bg-amber-500 text-white rounded-xl hover:bg-amber-600 transition font-medium"
                    >
                        å®Œæˆ
                    </button>
                </div>
            </div>

            <!-- è¿”å›æŒ‰é’® -->
            <div class="mt-auto pt-4" x-show="!translateResult">
                <button
                    @click="exitTranslateMode"
                    class="w-full py-3 bg-slate-700 text-slate-300 rounded-xl hover:bg-slate-600 transition"
                >
                    è¿”å›é€‰æ‹©
                </button>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
function readingPage() {
    return {
        // æ•°æ®
        bookId: '{{ book_id }}',
        bookName: '{{ book_name }}',
        unit: '{{ unit }}',
        passage: '',
        sentences: [],
        wordsUsed: [],

        // çŠ¶æ€
        phase: 'select',  // select, sentence, full, result, translate
        isLoading: false,
        loadingText: 'æ­£åœ¨ç”ŸæˆçŸ­æ–‡...',
        error: null,
        isPlaying: false,
        isRecording: false,
        isAssessing: false,
        recorderReady: false,

        // ç¿»è¯‘ç»ƒä¹ æ•°æ®
        translateResult: null,        // ç¿»è¯‘è¯„ä¼°ç»“æœ
        isTranslateRecording: false,  // æ˜¯å¦æ­£åœ¨å½•åˆ¶ç¿»è¯‘
        isTranslateAssessing: false,  // æ˜¯å¦æ­£åœ¨è¯„ä¼°ç¿»è¯‘
        translateRecorder: null,      // ç¿»è¯‘å½•éŸ³å™¨

        // é€å¥æ¨¡å¼æ•°æ®
        currentSentenceIndex: 0,
        sentenceResults: [],

        // æ•´ç¯‡æ¨¡å¼æ•°æ®
        fullResult: null,

        // ç»“æœæ•°æ®
        overallScore: 0,
        feedback: null,

        // å•è¯ä¸“é¡¹ç»ƒä¹ 
        showWordPractice: false,
        practiceWords: [],
        currentPracticeIndex: 0,
        practiceResult: null,
        isPracticeRecording: false,
        isPracticeAssessing: false,
        practiceWordAudioCache: {},  // ç»ƒä¹ å•è¯éŸ³é¢‘ç¼“å­˜

        // ç¼“å­˜ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰
        _cachedOmittedWords: null,
        _cachedMispronouncedWords: null,

        // å½•éŸ³ç›¸å…³
        recorder: null,
        recordingStartTime: null,
        recordingDuration: '0:00',
        recordingTimer: null,

        async init() {
            try {
                // æ£€æŸ¥å½•éŸ³æ”¯æŒ
                if (!AudioRecorder.isSupported()) {
                    this.error = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Safari';
                    return;
                }

                // åˆå§‹åŒ–å½•éŸ³å™¨
                this.recorder = new AudioRecorder();
                const hasPermission = await this.recorder.requestPermission();
                if (!hasPermission) {
                    this.error = 'è¯·å…è®¸ä½¿ç”¨éº¦å…‹é£ä»¥è¿›è¡Œè·Ÿè¯»ç»ƒä¹ ';
                    return;
                }
                this.recorderReady = true;

                // ç”ŸæˆçŸ­æ–‡
                await this.generatePassage();

            } catch (e) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', e);
                this.error = 'åˆå§‹åŒ–å¤±è´¥: ' + e.message;
            }
        },

        async generatePassage() {
            this.isLoading = true;
            this.loadingText = 'æ­£åœ¨ç”ŸæˆçŸ­æ–‡...';

            try {
                let url = `/api/reading/generate?book_id=${encodeURIComponent(this.bookId)}`;
                if (this.unit) {
                    url += `&unit=${encodeURIComponent(this.unit)}`;
                }

                const response = await fetch(url, { method: 'POST' });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'API è¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();

                this.passage = data.passage;
                this.sentences = data.sentences;
                this.wordsUsed = data.words_used || [];
                this.sentenceResults = new Array(this.sentences.length).fill(null);

            } catch (e) {
                console.error('ç”ŸæˆçŸ­æ–‡å¤±è´¥:', e);
                this.error = 'ç”ŸæˆçŸ­æ–‡å¤±è´¥: ' + e.message;
            }

            this.isLoading = false;
        },

        async regeneratePassage() {
            this.passage = '';
            this.sentences = [];
            this.wordsUsed = [];
            this.sentenceResults = [];
            this.currentSentenceIndex = 0;
            this.phase = 'select';
            await this.generatePassage();
        },

        async playFullPassage() {
            await this.playTTS(this.passage, 'en');
        },

        async playCurrentSentence() {
            if (this.sentences[this.currentSentenceIndex]) {
                await this.playTTS(this.sentences[this.currentSentenceIndex], 'en');
            }
        },

        async playTTS(text, lang = 'en') {
            if (!text || this.isPlaying) return;

            this.isPlaying = true;
            try {
                if (lang === 'zh') {
                    await TTS.playChinese(text);
                } else {
                    await TTS.playSentence(text);
                }
            } catch (e) {
                console.error('TTS æ’­æ”¾å¤±è´¥:', e);
            } finally {
                this.isPlaying = false;
            }
        },

        startSentenceMode() {
            this.phase = 'sentence';
            this.currentSentenceIndex = 0;
            this.sentenceResults = new Array(this.sentences.length).fill(null);
        },

        startFullMode() {
            this.phase = 'full';
        },

        // ==================== ç¿»è¯‘ç»ƒä¹ ç›¸å…³æ–¹æ³• ====================

        startTranslateMode() {
            // æ£€æŸ¥æ˜¯å¦æœ‰çŸ­æ–‡
            if (!this.passage) {
                alert('è¯·å…ˆç”ŸæˆçŸ­æ–‡');
                return;
            }

            // åˆå§‹åŒ–ç¿»è¯‘ç»ƒä¹ 
            this.translateResult = null;
            this.phase = 'translate';
        },

        async playPassageAudio() {
            if (this.isPlaying || !this.passage) return;

            this.isPlaying = true;
            try {
                await TTS.playSentence(this.passage);
            } catch (e) {
                console.error('æ’­æ”¾å¤±è´¥:', e);
            } finally {
                this.isPlaying = false;
            }
        },

        async startTranslateRecording() {
            if (this.isTranslateAssessing || !this.recorderReady) return;

            try {
                // ä½¿ç”¨åŒä¸€ä¸ª recorder å®ä¾‹
                if (!this.translateRecorder) {
                    this.translateRecorder = new AudioRecorder();
                }
                await this.translateRecorder.start();
                this.isTranslateRecording = true;
            } catch (e) {
                console.error('ç¿»è¯‘å½•éŸ³å¯åŠ¨å¤±è´¥:', e);
                alert('å½•éŸ³å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™');
            }
        },

        async stopTranslateRecording() {
            if (!this.isTranslateRecording) return;

            try {
                const audioBlob = await this.translateRecorder.stop();
                this.isTranslateRecording = false;

                // æ£€æŸ¥å½•éŸ³å¤§å°
                if (audioBlob.size < 1000) {
                    console.log('ç¿»è¯‘å½•éŸ³å¤ªçŸ­ï¼Œå¿½ç•¥');
                    return;
                }

                this.isTranslateAssessing = true;

                // æäº¤ç¿»è¯‘è¯„ä¼°
                await this.submitPassageTranslation(audioBlob);

            } catch (e) {
                console.error('ç¿»è¯‘å½•éŸ³å¤„ç†å¤±è´¥:', e);
                alert('å½•éŸ³å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                this.isTranslateAssessing = false;
            }
        },

        async submitPassageTranslation(audioBlob) {
            // æ„å»º FormData
            const formData = new FormData();

            // æ ¹æ® audioBlob ç±»å‹ç¡®å®šæ–‡ä»¶å
            let filename = 'recording.webm';
            if (audioBlob.type.includes('mp4')) {
                filename = 'recording.m4a';
            } else if (audioBlob.type.includes('ogg')) {
                filename = 'recording.ogg';
            } else if (audioBlob.type.includes('wav')) {
                filename = 'recording.wav';
            }

            formData.append('audio', audioBlob, filename);
            formData.append('passage', this.passage);  // è‹±æ–‡çŸ­æ–‡
            formData.append('book_id', this.bookId);

            console.log('[çŸ­æ–‡ç¿»è¯‘] çŸ­æ–‡:', this.passage.substring(0, 50) + '...');

            try {
                const response = await fetch('/api/translation/passage', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    this.translateResult = await response.json();
                    console.log('[çŸ­æ–‡ç¿»è¯‘] ç»“æœ:', this.translateResult);
                } else {
                    const errorData = await response.json();
                    this.translateResult = {
                        success: false,
                        recognized_text: '',
                        reference_text: '(ç”Ÿæˆå¤±è´¥)',
                        score: 0,
                        feedback: errorData.error || 'è¯„ä¼°å¤±è´¥',
                        strengths: [],
                        issues: ['æœåŠ¡é”™è¯¯'],
                        suggestion: 'è¯·ç¨åé‡è¯•'
                    };
                }
            } catch (e) {
                console.error('ç¿»è¯‘è¯„ä¼°è¯·æ±‚å¤±è´¥:', e);
                this.translateResult = {
                    success: false,
                    recognized_text: '',
                    reference_text: '(ç½‘ç»œé”™è¯¯)',
                    score: 0,
                    feedback: 'ç½‘ç»œé”™è¯¯',
                    strengths: [],
                    issues: ['è¯·æ±‚å¤±è´¥'],
                    suggestion: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
                };
            }
        },

        retryTranslate() {
            // é‡æ–°ç¿»è¯‘
            this.translateResult = null;
        },

        finishTranslate() {
            // å®Œæˆç¿»è¯‘ï¼Œè¿”å›é€‰æ‹©é¡µé¢
            this.phase = 'select';
            this.translateResult = null;
        },

        exitTranslateMode() {
            this.phase = 'select';
            this.translateResult = null;
        },

        // ==================== åŸæœ‰å½•éŸ³æ–¹æ³• ====================

        async startRecording() {
            if (this.isAssessing || !this.recorderReady) return;

            try {
                await this.recorder.start();
                this.isRecording = true;

                // å¼€å§‹è®¡æ—¶ï¼ˆ500ms æ›´æ–°ä¸€æ¬¡ï¼ŒèŠ‚çœæ€§èƒ½ï¼‰
                this.recordingStartTime = Date.now();
                this.recordingDuration = '0:00';
                this.recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.recordingStartTime) / 1000);
                    const mins = Math.floor(elapsed / 60);
                    const secs = elapsed % 60;
                    this.recordingDuration = `${mins}:${secs.toString().padStart(2, '0')}`;
                }, 500);

            } catch (e) {
                console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', e);
                alert('å½•éŸ³å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™');
            }
        },

        async stopRecording() {
            if (!this.isRecording) return;

            // åœæ­¢è®¡æ—¶
            if (this.recordingTimer) {
                clearInterval(this.recordingTimer);
                this.recordingTimer = null;
            }

            try {
                const audioBlob = await this.recorder.stop();
                this.isRecording = false;

                // æ£€æŸ¥å½•éŸ³æ—¶é•¿
                if (audioBlob.size < 1000) {
                    console.log('å½•éŸ³å¤ªçŸ­ï¼Œå¿½ç•¥');
                    return;
                }

                this.isAssessing = true;

                // æ ¹æ®æ¨¡å¼è¯„ä¼°
                if (this.phase === 'sentence') {
                    await this.assessSentence(audioBlob);
                } else if (this.phase === 'full') {
                    await this.assessFullPassage(audioBlob);
                }

            } catch (e) {
                console.error('å½•éŸ³å¤„ç†å¤±è´¥:', e);
                alert('å½•éŸ³å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                this.isAssessing = false;
            }
        },

        async assessSentence(audioBlob) {
            const sentence = this.sentences[this.currentSentenceIndex];

            // æ ¹æ® audioBlob çš„ MIME ç±»å‹ç¡®å®šæ–‡ä»¶æ‰©å±•å
            let filename = 'recording.webm';
            if (audioBlob.type.includes('mp4')) {
                filename = 'recording.m4a';
            } else if (audioBlob.type.includes('ogg')) {
                filename = 'recording.ogg';
            } else if (audioBlob.type.includes('wav')) {
                filename = 'recording.wav';
            }
            console.log('[DEBUG] éŸ³é¢‘ç±»å‹:', audioBlob.type, 'æ–‡ä»¶å:', filename);

            const formData = new FormData();
            formData.append('audio', audioBlob, filename);
            formData.append('sentence', sentence);
            formData.append('book_id', this.bookId);

            try {
                const response = await fetch('/api/reading/assess-sentence', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'è¯„ä¼°å¤±è´¥');
                }

                const result = await response.json();

                this.sentenceResults[this.currentSentenceIndex] = {
                    accuracy: result.accuracy_score,
                    fluency: result.fluency_score,
                    completeness: result.completeness_score,
                    problemWords: result.problem_words || [],
                    omittedWords: result.omitted_words || [],
                    mispronouncedWords: result.mispronounced_words || []
                };
                // æ¸…é™¤ç¼“å­˜
                this.clearResultsCache();

            } catch (e) {
                console.error('å¥å­è¯„ä¼°å¤±è´¥:', e);
                alert('è¯„ä¼°å¤±è´¥: ' + e.message);
            }
        },

        async assessFullPassage(audioBlob) {
            // æ ¹æ® audioBlob çš„ MIME ç±»å‹ç¡®å®šæ–‡ä»¶æ‰©å±•å
            let filename = 'recording.webm';
            if (audioBlob.type.includes('mp4')) {
                filename = 'recording.m4a';
            } else if (audioBlob.type.includes('ogg')) {
                filename = 'recording.ogg';
            } else if (audioBlob.type.includes('wav')) {
                filename = 'recording.wav';
            }
            console.log('[DEBUG] æ•´ç¯‡æ¨¡å¼ - éŸ³é¢‘ç±»å‹:', audioBlob.type, 'æ–‡ä»¶å:', filename);

            const formData = new FormData();
            formData.append('audio', audioBlob, filename);
            formData.append('sentence', this.passage);
            formData.append('book_id', this.bookId);

            try {
                const response = await fetch('/api/reading/assess-sentence', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'è¯„ä¼°å¤±è´¥');
                }

                const result = await response.json();

                // æ•´ç¯‡æ¨¡å¼ï¼šä¸ºæ¯å¥è®¾ç½®ç›¸åŒçš„åˆ†æ•°ï¼ˆç®€åŒ–å¤„ç†ï¼‰
                // æˆ–è€…æ ¹æ® word_scores åˆ†é…åˆ°å„å¥
                this.fullResult = result;

                // ç®€å•å¤„ç†ï¼šæ‰€æœ‰å¥å­ä½¿ç”¨ç›¸åŒåˆ†æ•°ï¼Œä½†ä¿ç•™é”™è¯¯å•è¯ä¿¡æ¯
                for (let i = 0; i < this.sentences.length; i++) {
                    this.sentenceResults[i] = {
                        accuracy: result.accuracy_score,
                        fluency: result.fluency_score,
                        completeness: result.completeness_score,
                        problemWords: result.problem_words || [],
                        omittedWords: result.omitted_words || [],
                        mispronouncedWords: result.mispronounced_words || []
                    };
                }
                // æ¸…é™¤ç¼“å­˜
                this.clearResultsCache();

                // ç›´æ¥æ˜¾ç¤ºç»“æœ
                await this.showResults();

            } catch (e) {
                console.error('æ•´ç¯‡è¯„ä¼°å¤±è´¥:', e);
                alert('è¯„ä¼°å¤±è´¥: ' + e.message);
            }
        },

        nextSentence() {
            if (this.currentSentenceIndex < this.sentences.length - 1) {
                this.currentSentenceIndex++;
            }
        },

        async showResults() {
            this.isLoading = true;
            this.loadingText = 'æ­£åœ¨ç”Ÿæˆè¯„ä»·...';

            // è®¡ç®—æ€»åˆ†
            const validResults = this.sentenceResults.filter(r => r !== null && r.accuracy !== undefined);
            if (validResults.length > 0) {
                const total = validResults.reduce((sum, r) => sum + (r.accuracy || 0), 0);
                this.overallScore = Math.round(total / validResults.length);
            } else {
                this.overallScore = 0;
            }

            // ç¡®ä¿ overallScore æ˜¯æœ‰æ•ˆæ•°å­—
            if (isNaN(this.overallScore)) {
                this.overallScore = 0;
            }

            // è·å– LLM è¯„ä»·
            try {
                const response = await fetch('/api/reading/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        passage: this.passage,
                        sentences: this.sentences,
                        sentence_results: this.sentenceResults.map(r => r || { accuracy: 0 }),
                        overall_score: this.overallScore,
                        omitted_words: this.getAllOmittedWords(),
                        mispronounced_words: this.getAllMispronouncedWords()
                    })
                });

                if (response.ok) {
                    this.feedback = await response.json();
                } else {
                    console.error('è·å–è¯„ä»·å¤±è´¥:', await response.text());
                }

            } catch (e) {
                console.error('è·å–è¯„ä»·å¤±è´¥:', e);
            }

            this.isLoading = false;
            this.phase = 'result';
        },

        // è·å–æ‰€æœ‰æ¼è¯»å•è¯ï¼ˆå»é‡ï¼Œå¸¦ç¼“å­˜ï¼‰
        getAllOmittedWords() {
            if (this._cachedOmittedWords !== null) {
                return this._cachedOmittedWords;
            }
            const words = new Set();
            for (const result of this.sentenceResults) {
                if (result?.omittedWords) {
                    for (const word of result.omittedWords) {
                        words.add(word);
                    }
                }
            }
            this._cachedOmittedWords = Array.from(words);
            return this._cachedOmittedWords;
        },

        // è·å–æ‰€æœ‰è¯»é”™å•è¯ï¼ˆå»é‡ï¼Œä¿ç•™æœ€ä½å‡†ç¡®åº¦ï¼Œå¸¦ç¼“å­˜ï¼‰
        getAllMispronouncedWords() {
            if (this._cachedMispronouncedWords !== null) {
                return this._cachedMispronouncedWords;
            }
            const wordMap = new Map();
            for (const result of this.sentenceResults) {
                if (result?.mispronouncedWords) {
                    for (const pw of result.mispronouncedWords) {
                        const existing = wordMap.get(pw.word);
                        if (!existing || existing.accuracy > pw.accuracy) {
                            wordMap.set(pw.word, pw);
                        }
                    }
                }
            }
            this._cachedMispronouncedWords = Array.from(wordMap.values());
            return this._cachedMispronouncedWords;
        },

        // æ¸…é™¤ç¼“å­˜ï¼ˆå½“ sentenceResults å˜åŒ–æ—¶è°ƒç”¨ï¼‰
        clearResultsCache() {
            this._cachedOmittedWords = null;
            this._cachedMispronouncedWords = null;
        },

        // å¼€å§‹å•è¯ä¸“é¡¹ç»ƒä¹ 
        startWordPractice() {
            // æ”¶é›†æ‰€æœ‰éœ€è¦ç»ƒä¹ çš„å•è¯
            const omitted = this.getAllOmittedWords().map(w => ({ word: w, type: 'omitted' }));
            const mispronounced = this.getAllMispronouncedWords().map(pw => ({ word: pw.word, type: 'mispronounced', accuracy: pw.accuracy }));
            this.practiceWords = [...omitted, ...mispronounced];
            this.currentPracticeIndex = 0;
            this.practiceResult = null;
            this.showWordPractice = true;

            // é¢„åŠ è½½æ‰€æœ‰ç»ƒä¹ å•è¯çš„éŸ³é¢‘
            this.preloadPracticeWordAudios();
        },

        // é¢„åŠ è½½ç»ƒä¹ å•è¯éŸ³é¢‘
        preloadPracticeWordAudios() {
            this.practiceWords.forEach(pw => {
                const word = pw.word;
                if (!word || this.practiceWordAudioCache[word]) return;

                const url = `/api/tts/sentence?sentence=${encodeURIComponent(word)}`;
                this.practiceWordAudioCache[word] = new Howl({
                    src: [url],
                    format: ['mp3'],
                    preload: true,
                    onloaderror: (id, err) => {
                        console.error(`é¢„åŠ è½½ ${word} éŸ³é¢‘å¤±è´¥:`, err);
                        delete this.practiceWordAudioCache[word];
                    }
                });
            });
        },

        // æ’­æ”¾å½“å‰ç»ƒä¹ å•è¯
        async playPracticeWord() {
            const word = this.practiceWords[this.currentPracticeIndex]?.word;
            if (!word || this.isPlaying) return;

            this.isPlaying = true;

            // ä¼˜å…ˆä½¿ç”¨é¢„åŠ è½½ç¼“å­˜çš„éŸ³é¢‘
            const cachedHowl = this.practiceWordAudioCache[word];
            if (cachedHowl && cachedHowl.state() === 'loaded') {
                TTS.stop();  // åœæ­¢ç»Ÿä¸€ TTS æ’­æ”¾å™¨
                cachedHowl.off('end');
                cachedHowl.on('end', () => {
                    this.isPlaying = false;
                });
                cachedHowl.play();
            } else {
                // ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨ç»Ÿä¸€ TTS æ¨¡å—
                await this.playTTS(word, 'en');
            }
        },

        // å¼€å§‹ç»ƒä¹ å½•éŸ³
        async startPracticeRecording() {
            if (this.isPracticeAssessing || !this.recorderReady) return;

            try {
                await this.recorder.start();
                this.isPracticeRecording = true;
                this.practiceResult = null;
            } catch (e) {
                console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', e);
            }
        },

        // åœæ­¢ç»ƒä¹ å½•éŸ³å¹¶è¯„ä¼°
        async stopPracticeRecording() {
            if (!this.isPracticeRecording) return;

            try {
                const audioBlob = await this.recorder.stop();
                this.isPracticeRecording = false;

                if (audioBlob.size < 1000) {
                    return;
                }

                this.isPracticeAssessing = true;

                const word = this.practiceWords[this.currentPracticeIndex]?.word;
                if (!word) return;

                // ç¡®å®šæ–‡ä»¶å
                let filename = 'recording.webm';
                if (audioBlob.type.includes('mp4')) {
                    filename = 'recording.m4a';
                } else if (audioBlob.type.includes('ogg')) {
                    filename = 'recording.ogg';
                } else if (audioBlob.type.includes('wav')) {
                    filename = 'recording.wav';
                }

                const formData = new FormData();
                formData.append('audio', audioBlob, filename);
                formData.append('word', word);
                formData.append('book_id', this.bookId);

                const response = await fetch('/api/pronunciation/assess', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    this.practiceResult = {
                        accuracy: result.accuracy_score || 0
                    };
                }

            } catch (e) {
                console.error('ç»ƒä¹ è¯„ä¼°å¤±è´¥:', e);
            } finally {
                this.isPracticeAssessing = false;
            }
        },

        // ä¸Šä¸€ä¸ªç»ƒä¹ å•è¯
        prevPracticeWord() {
            if (this.currentPracticeIndex > 0) {
                this.currentPracticeIndex--;
                this.practiceResult = null;
            }
        },

        // ä¸‹ä¸€ä¸ªç»ƒä¹ å•è¯
        nextPracticeWord() {
            if (this.currentPracticeIndex < this.practiceWords.length - 1) {
                this.currentPracticeIndex++;
                this.practiceResult = null;
            }
        },

        // ç»“æŸå•è¯ç»ƒä¹ 
        endWordPractice() {
            this.showWordPractice = false;
            this.practiceWords = [];
            this.currentPracticeIndex = 0;
            this.practiceResult = null;

            // æ¸…é™¤éŸ³é¢‘ç¼“å­˜
            Object.values(this.practiceWordAudioCache).forEach(howl => howl.unload());
            this.practiceWordAudioCache = {};
        },

        restart() {
            this.phase = 'select';
            this.currentSentenceIndex = 0;
            this.sentenceResults = new Array(this.sentences.length).fill(null);
            this.fullResult = null;
            this.overallScore = 0;
            this.feedback = null;
            // é‡ç½®ä¸“é¡¹ç»ƒä¹ çŠ¶æ€
            this.showWordPractice = false;
            this.practiceWords = [];
            this.currentPracticeIndex = 0;
            this.practiceResult = null;
        },

        goBack() {
            // æ¸…ç†å½•éŸ³å™¨
            if (this.recorder) {
                this.recorder.cancel();
            }
            if (this.recordingTimer) {
                clearInterval(this.recordingTimer);
            }
            TTS.stop();

            window.location.href = '/';
        }
    }
}
</script>
{% endblock %}
