{% extends "base.html" %}

{% block title %}英语学习{% endblock %}

{% block head %}
<script src="/static/chart.min.js"></script>
{% endblock %}

{% block body %}
<div class="min-h-screen bg-slate-900" x-data="indexPage()">
    <!-- 顶部导航 -->
    <header class="bg-slate-800/80 backdrop-blur-sm shadow-lg sticky top-0 z-10 border-b border-slate-700/50">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <h1 class="text-xl font-bold text-slate-100">英语学习</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-slate-400 text-sm">{{ user.username }}</span>
                <button
                    @click="logout"
                    class="text-slate-400 hover:text-red-400 transition"
                    title="退出登录"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- 主内容 -->
    <main class="max-w-4xl mx-auto px-4 py-6">
        <!-- 全局学习统计 -->
        <div class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4">
            <h2 class="text-sm text-slate-400 mb-3">学习统计（全部词书）</h2>
            <div class="grid grid-cols-4 gap-3 text-center">
                <div class="bg-sky-500/10 border border-sky-500/20 rounded-lg p-3">
                    <div class="text-xl font-bold text-sky-400" x-text="globalStats?.words_learned || 0"></div>
                    <div class="text-xs text-slate-400">已学</div>
                </div>
                <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3">
                    <div class="text-xl font-bold text-emerald-400" x-text="globalStats?.mastered || 0"></div>
                    <div class="text-xs text-slate-400">已掌握</div>
                </div>
                <div class="bg-amber-500/10 border border-amber-500/20 rounded-lg p-3">
                    <div class="text-xl font-bold text-amber-400" x-text="globalStats?.due_today || 0"></div>
                    <div class="text-xs text-slate-400">待复习</div>
                </div>
                <div class="bg-violet-500/10 border border-violet-500/20 rounded-lg p-3">
                    <div class="text-xl font-bold text-violet-400" x-text="(globalStats?.accuracy || 0) + '%'"></div>
                    <div class="text-xs text-slate-400">正确率</div>
                </div>
            </div>
        </div>

        <!-- 掌握曲线图 -->
        <div class="bg-slate-800/50 backdrop-blur rounded-xl shadow-lg border border-slate-700/50 p-5 mb-4">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-sm text-slate-400">掌握曲线</h2>
                <div class="flex space-x-2">
                    <button
                        @click="loadCurve(7)"
                        :class="curveDays === 7 ? 'bg-sky-500 text-white' : 'bg-slate-700 text-slate-300'"
                        class="px-2 py-1 text-xs rounded"
                    >7天</button>
                    <button
                        @click="loadCurve(30)"
                        :class="curveDays === 30 ? 'bg-sky-500 text-white' : 'bg-slate-700 text-slate-300'"
                        class="px-2 py-1 text-xs rounded"
                    >30天</button>
                    <button
                        @click="loadCurve(0)"
                        :class="curveDays === 0 ? 'bg-sky-500 text-white' : 'bg-slate-700 text-slate-300'"
                        class="px-2 py-1 text-xs rounded"
                    >全部</button>
                </div>
            </div>
            <div class="h-48">
                <canvas id="masteredChart"></canvas>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="grid grid-cols-2 gap-4 mb-4">
            <!-- 全局复习按钮 -->
            <button
                @click="showReviewModal = true"
                :disabled="!globalStats?.due_today"
                class="bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-xl font-medium hover:from-amber-600 hover:to-orange-600 transition shadow-lg shadow-orange-500/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
            >
                <div class="text-lg">复习</div>
                <div class="text-sm opacity-80" x-text="(globalStats?.due_today || 0) + ' 个待复习'"></div>
            </button>
            <!-- 学新词按钮（需要选择词书） -->
            <button
                @click="showNewWordsModal = true"
                class="bg-gradient-to-r from-sky-500 to-blue-500 text-white py-4 rounded-xl font-medium hover:from-sky-600 hover:to-blue-600 transition shadow-lg shadow-blue-500/20"
            >
                <div class="text-lg">学新词</div>
                <div class="text-sm opacity-80">选择词书开始学习</div>
            </button>
        </div>

        <!-- 对话和跟读练习 -->
        <div class="grid grid-cols-2 gap-4">
            <button
                @click="showConversationModal = true"
                :disabled="!globalStats?.words_learned"
                class="bg-gradient-to-r from-violet-500 to-purple-500 text-white py-4 rounded-xl font-medium hover:from-violet-600 hover:to-purple-600 transition shadow-lg shadow-purple-500/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
            >
                <div class="text-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    对话练习
                </div>
            </button>
            <button
                @click="showReadingModal = true"
                :disabled="!globalStats?.words_learned"
                class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-4 rounded-xl font-medium hover:from-emerald-600 hover:to-teal-600 transition shadow-lg shadow-teal-500/20 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
            >
                <div class="text-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    跟读练习
                </div>
            </button>
        </div>
    </main>

    <!-- 复习弹窗 -->
    <div x-show="showReviewModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showReviewModal = false">
        <div class="bg-slate-800 rounded-xl p-6 w-80">
            <h3 class="text-lg font-bold text-slate-100 mb-4">复习设置</h3>
            <div class="text-sm text-slate-400 mb-4">
                今日待复习: <span class="text-amber-400 font-medium" x-text="globalStats?.due_today || 0"></span> 个单词
            </div>
            <div class="mb-4">
                <label class="text-xs text-slate-400 mb-1 block">复习数量</label>
                <input
                    type="number"
                    x-model="reviewLimit"
                    min="1"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 text-slate-200 rounded-lg text-sm"
                />
            </div>
            <div class="flex space-x-3">
                <button
                    @click="showReviewModal = false"
                    class="flex-1 px-4 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500"
                >取消</button>
                <button
                    @click="startReview"
                    class="flex-1 px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg hover:from-amber-600 hover:to-orange-600"
                >开始复习</button>
            </div>
        </div>
    </div>

    <!-- 学新词弹窗 -->
    <div x-show="showNewWordsModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showNewWordsModal = false">
        <div class="bg-slate-800 rounded-xl p-6 w-80 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-slate-100 mb-4">选择词书</h3>
            <div class="space-y-2 mb-4">
                {% for book in books %}
                <button
                    @click="selectedBookForNew = '{{ book.id }}'; selectedBookName = '{{ book.name }}'"
                    class="w-full text-left px-4 py-3 rounded-lg transition"
                    :class="selectedBookForNew === '{{ book.id }}' ? 'bg-sky-600 text-white' : 'bg-slate-700 text-slate-200 hover:bg-slate-600'"
                >
                    {{ book.name }}
                </button>
                {% endfor %}
            </div>
            <!-- 章节选择 -->
            <div x-show="selectedBookForNew" class="mb-4">
                <label class="text-xs text-slate-400 mb-1 block">章节（可选）</label>
                <select
                    x-model="selectedUnit"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 text-slate-200 rounded-lg text-sm"
                >
                    <option value="">全部</option>
                    <template x-for="unit in units" :key="unit">
                        <option :value="unit" x-text="unit"></option>
                    </template>
                </select>
            </div>
            <!-- 数量选择 -->
            <div class="mb-4">
                <label class="text-xs text-slate-400 mb-1 block">数量</label>
                <input
                    type="number"
                    x-model="selectedLimit"
                    min="1"
                    max="100"
                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 text-slate-200 rounded-lg text-sm"
                />
            </div>
            <div class="flex space-x-3">
                <button
                    @click="showNewWordsModal = false"
                    class="flex-1 px-4 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500"
                >取消</button>
                <button
                    @click="startNewWords"
                    :disabled="!selectedBookForNew"
                    class="flex-1 px-4 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-400 disabled:opacity-50 disabled:cursor-not-allowed"
                >开始学习</button>
            </div>
        </div>
    </div>

    <!-- 对话练习弹窗 -->
    <div x-show="showConversationModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showConversationModal = false">
        <div class="bg-slate-800 rounded-xl p-6 w-80 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-slate-100 mb-4">选择词书</h3>
            <div class="space-y-2 mb-4">
                {% for book in books %}
                <button
                    @click="selectedBookForConv = '{{ book.id }}'"
                    class="w-full text-left px-4 py-3 rounded-lg transition"
                    :class="selectedBookForConv === '{{ book.id }}' ? 'bg-violet-600 text-white' : 'bg-slate-700 text-slate-200 hover:bg-slate-600'"
                >
                    {{ book.name }}
                </button>
                {% endfor %}
            </div>
            <div class="flex space-x-3">
                <button
                    @click="showConversationModal = false"
                    class="flex-1 px-4 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500"
                >取消</button>
                <button
                    @click="startConversation"
                    :disabled="!selectedBookForConv"
                    class="flex-1 px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-400 disabled:opacity-50 disabled:cursor-not-allowed"
                >开始练习</button>
            </div>
        </div>
    </div>

    <!-- 跟读练习弹窗 -->
    <div x-show="showReadingModal" x-cloak class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.self="showReadingModal = false">
        <div class="bg-slate-800 rounded-xl p-6 w-80 max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-slate-100 mb-4">选择词书</h3>
            <div class="space-y-2 mb-4">
                {% for book in books %}
                <button
                    @click="selectedBookForReading = '{{ book.id }}'"
                    class="w-full text-left px-4 py-3 rounded-lg transition"
                    :class="selectedBookForReading === '{{ book.id }}' ? 'bg-emerald-600 text-white' : 'bg-slate-700 text-slate-200 hover:bg-slate-600'"
                >
                    {{ book.name }}
                </button>
                {% endfor %}
            </div>
            <div class="flex space-x-3">
                <button
                    @click="showReadingModal = false"
                    class="flex-1 px-4 py-2 bg-slate-600 text-slate-200 rounded-lg hover:bg-slate-500"
                >取消</button>
                <button
                    @click="startReading"
                    :disabled="!selectedBookForReading"
                    class="flex-1 px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-400 disabled:opacity-50 disabled:cursor-not-allowed"
                >开始练习</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function indexPage() {
    return {
        globalStats: null,
        curveData: null,
        curveDays: 7,
        chart: null,

        // 弹窗状态
        showReviewModal: false,
        showNewWordsModal: false,
        showConversationModal: false,
        showReadingModal: false,

        // 复习选项
        reviewLimit: 20,

        // 学新词选项
        selectedBookForNew: null,
        selectedBookName: null,
        selectedUnit: '',
        selectedLimit: '20',
        units: [],

        // 对话和跟读选项
        selectedBookForConv: null,
        selectedBookForReading: null,

        async init() {
            await Promise.all([
                this.loadGlobalStats(),
                this.loadCurve(7)
            ]);

            // 监听词书选择变化，加载章节
            this.$watch('selectedBookForNew', async (bookId) => {
                if (bookId) {
                    await this.loadUnits(bookId);
                } else {
                    this.units = [];
                }
            });
        },

        async loadGlobalStats() {
            try {
                const response = await fetch('/api/stats/global');
                if (response.ok) {
                    this.globalStats = await response.json();
                }
            } catch (e) {
                console.error('加载全局统计失败:', e);
            }
        },

        async loadCurve(days) {
            this.curveDays = days;
            try {
                const url = days > 0 ? `/api/stats/mastered-curve?days=${days}` : '/api/stats/mastered-curve?days=365';
                const response = await fetch(url);
                if (response.ok) {
                    this.curveData = await response.json();
                    this.renderChart();
                }
            } catch (e) {
                console.error('加载曲线数据失败:', e);
            }
        },

        renderChart() {
            const ctx = document.getElementById('masteredChart');
            if (!ctx || !this.curveData) return;

            if (this.chart) {
                this.chart.destroy();
            }

            this.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: this.curveData.dates || [],
                    datasets: [{
                        label: '掌握单词数',
                        data: this.curveData.counts || [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            },
                            ticks: {
                                color: 'rgb(148, 163, 184)',
                                maxTicksLimit: 7
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            },
                            ticks: {
                                color: 'rgb(148, 163, 184)',
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        },

        async loadUnits(bookId) {
            try {
                const response = await fetch(`/api/book/${bookId}/units`);
                if (response.ok) {
                    const data = await response.json();
                    this.units = data.units || [];
                }
            } catch (e) {
                console.error('加载章节失败:', e);
                this.units = [];
            }
        },

        startReview() {
            // 全局复习，不指定词书
            let url = `/dictation?mode=review&limit=${this.reviewLimit || 20}`;
            window.location.href = url;
            this.showReviewModal = false;
        },

        startNewWords() {
            if (!this.selectedBookForNew) return;
            let url = `/dictation/${this.selectedBookForNew}?mode=new`;
            if (this.selectedUnit) {
                url += `&unit=${encodeURIComponent(this.selectedUnit)}`;
            }
            url += `&limit=${this.selectedLimit || 20}`;
            window.location.href = url;
            this.showNewWordsModal = false;
        },

        startConversation() {
            if (!this.selectedBookForConv) return;
            window.location.href = `/conversation-setup/${this.selectedBookForConv}`;
            this.showConversationModal = false;
        },

        startReading() {
            if (!this.selectedBookForReading) return;
            window.location.href = `/reading/${this.selectedBookForReading}`;
            this.showReadingModal = false;
        },

        async logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                localStorage.removeItem('selectedBook');
                localStorage.removeItem('selectedBookName');
                window.location.href = '/login';
            } catch (e) {
                console.error('退出失败:', e);
            }
        }
    }
}
</script>
{% endblock %}
